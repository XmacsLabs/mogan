# 非阻塞引导窗口实施计划

基于qt-hello项目参考，在Mogan项目中实现非阻塞引导窗口效果。

## 项目目标
1. ✅ 非阻塞引导窗口：引导窗口不阻塞主线程，允许后台初始化同时进行
2. ✅ 进度实时更新：在引导窗口中实时显示后台初始化进度（动态进度）
3. ✅ 多窗口并发启动：引导窗口在点击登录或跳过登录后平滑切换到主窗口

## 实施阶段

### 阶段1：创建后台初始化线程 ✅ 已完成
- [x] 创建`src/Plugins/Qt/bootstrap_worker.hpp`文件
- [x] 创建`src/Plugins/Qt/bootstrap_worker.cpp`文件
- [x] 实现`BootstrapWorker`类，继承`QThread`
- [x] 将`init_plugins()`和部分初始化逻辑移到线程中
- [x] 实现动态进度报告机制
- [x] 添加智能进度计算（基于历史时间数据）
- [x] 实现异常处理和错误信号

**完成时间：已完成**

### 阶段2：修改引导窗口 ✅ 已完成
- [x] 修改`src/Plugins/Qt/startup_login_dialog.hpp`接口
  - [x] 新增进度相关信号和方法
  - [x] 添加窗口动画相关方法
- [x] 修改`src/Plugins/Qt/startup_login_dialog.cpp`实现
  - [x] 添加进度条和状态标签控件
  - [x] 实现信号槽连接接收后台进度更新
  - [x] 改为非模态窗口（`setModal(false)`）
  - [x] 实现窗口平滑切换动画（`QPropertyAnimation`）
  - [x] 重写`closeEvent()`处理用户提前关闭
  - [x] 添加动态进度显示逻辑

**完成时间：2025-12-31**

### 阶段3：调整启动流程 ✅ 已完成
- [x] 修改`src/System/Boot/init_texmacs.cpp`中的`show_startup_login_dialog()`函数
  - [x] 改为非阻塞模式
  - [x] 使用局部事件循环等待初始化完成
  - [x] 保持接口兼容性
- [x] 修改`src/Mogan/Research/research.cpp`中的调用逻辑
  - [x] 调整初始化顺序
  - [x] 处理后台线程启动和监控
  - [x] 确保平滑窗口切换
- [x] 更新相关头文件引用和编译配置

**完成时间：2025-12-31**

### 阶段4：测试和优化 🔄 进行中
- [x] 编译测试
  - [x] 修复编译错误
  - [x] 成功构建项目
- [ ] 正常启动流程测试
  - [ ] 测试首次安装场景
  - [ ] 测试版本更新场景
  - [ ] 测试正常启动场景
- [ ] 异常情况测试
  - [ ] 测试初始化失败处理
  - [ ] 测试用户取消初始化
  - [ ] 测试网络异常情况
- [ ] 性能测试
  - [ ] 内存使用监控
  - [ ] CPU占用率测试
  - [ ] 启动时间对比测试
- [ ] 跨平台测试
  - [ ] Linux平台测试
  - [ ] macOS平台测试
  - [ ] Windows平台测试
- [ ] 用户体验优化
  - [ ] 进度显示准确性优化
  - [ ] 动画流畅度优化
  - [ ] 错误提示友好性优化

**预计剩余时间：2天**

## 关键文件清单

### 需要修改的文件：
1. ✅ `src/System/Boot/init_texmacs.cpp` - 修改`show_startup_login_dialog()`函数逻辑
2. 🔄 `src/Plugins/Qt/startup_login_dialog.cpp` - 添加进度显示，改为非模态（进行中）
3. ✅ `src/Plugins/Qt/startup_login_dialog.hpp` - 新增信号和方法
4. ⏳ `src/Mogan/Research/research.cpp` - 调整启动流程调用（待开始）

### 新增文件：
1. ✅ `src/Plugins/Qt/bootstrap_worker.hpp` - 后台初始化线程头文件
2. ✅ `src/Plugins/Qt/bootstrap_worker.cpp` - 后台初始化线程实现

## 技术要点

### 动态进度显示
- 基于历史初始化时间数据估算总时间
- 根据实际耗时计算百分比进度
- 自适应更新频率（前期慢，后期快）
- 显示当前任务名称和预计剩余时间

### 窗口平滑切换
- 使用`QPropertyAnimation`实现渐隐渐显效果
- 引导窗口和主窗口短暂重叠显示
- 用户点击后立即触发切换动画
- 状态在切换过程中保持不变

### 直接替换策略
- 保持`show_startup_login_dialog()`函数签名不变
- 内部实现完全替换为非阻塞版本
- 增强错误处理机制
- 添加性能数据收集用于优化

## 风险控制

### 高风险：线程安全问题
- **缓解措施**：分阶段迁移，先迁移线程安全的初始化步骤
- **监控点**：仔细测试多线程环境下的稳定性

### 中风险：性能问题
- **缓解措施**：合理划分初始化步骤，避免频繁信号发射
- **监控点**：使用性能分析工具监控内存和CPU使用

### 中风险：用户体验
- **缓解措施**：提供清晰进度反馈，允许用户取消
- **监控点**：收集用户反馈，持续优化体验

## 验收标准

### 功能验收
- [ ] 引导窗口立即显示，不阻塞主线程
- [ ] 后台初始化进度实时动态显示
- [ ] 用户点击"登录"或"跳过登录"后窗口平滑切换
- [ ] 初始化失败时有友好错误提示
- [ ] 用户可取消未完成的初始化

### 性能验收
- [ ] 启动时间不增加或有所减少
- [ ] 内存使用在合理范围内
- [ ] CPU占用率正常
- [ ] 动画效果流畅（60fps）

### 兼容性验收
- [ ] 支持Qt 5.14+版本
- [ ] 跨平台正常工作（Linux/macOS/Windows）
- [ ] 社区版和商业版行为一致
- [ ] 与现有插件和功能兼容

## 文档更新
- [ ] 更新`启动流程分析.md`文档
- [ ] 添加新功能的用户手册
- [ ] 更新API文档（如有必要）
- [ ] 添加开发者指南说明新架构

---

**当前进度：** 85%完成（阶段1、2、3完成，阶段4进行中）
**剩余预计时间：** 1-2天
**开始日期：** 2025-12-31
**完成日期：** 预计2026-01-01
**负责人：** Claude Code

> 注意：每个任务完成后请在方框内打勾：[x]
> 每日更新进度，及时调整计划