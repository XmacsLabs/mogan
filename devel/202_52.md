# 202_52 高 DPI 支持：变更记录 与 后续重构计划

本文档记录了修复 Windows 上高 DPI所做的修改。

偏移问题 [x]
实现对 125%/150% 的彻底支持 [ ]

## 如何测试

在Windows设备上，缩放比设置125%/150%，然后主要测试三个地方：

在main分支上

- 软件窗口整体放在右半边，靠近右侧的菜单会偏移
- 点击 `编辑 -> 首选项` 把弹窗移动到屏幕右侧，点击选择框会出现偏移
- 点击 `格式 -> 页面` ，点击辅助窗口上的选择框，会偏移

## 2025/09/29

### What

修复/缓解了 Windows 下部分界面在高 DPI（例如 125%）下控件“左移/错位”的可见问题：因为 Qt 的高 DPI 属性在应用启动前设置，Qt 的布局与像素比协调得更好，部分控件得以对齐。

### How

#### 改动部分

- 在 `src/Mogan/Research/research.cpp`：将 Qt 的高 DPI 属性提前设置到创建 `QApplication` 之前，加入：
	- `QCoreApplication::setAttribute(Qt::AA_EnableHighDpiScaling)`
	- `QCoreApplication::setAttribute(Qt::AA_UseHighDpiPixmaps)`
	- 根据平台/版本设置 `QGuiApplication::setHighDpiScaleFactorRoundingPolicy(...)`（对 Windows 使用 `RoundPreferFloor`，在其他平台使用 `PassThrough`）。

- 在 `src/Plugins/Qt/QTMApplication.hpp`：调整头文件包含以确保 `QGuiApplication` 可用，并把 rounding policy 的调用限制在合适的平台/版本上。

- 删除重复的设置: 在`qt_gui.cpp`的`qApp->setAttribute (Qt::AA_UseHighDpiPixmaps);` ; 在`QTMApplication.hpp`的`QGuiApplication::setHighDpiScaleFactorRoundingPolicy`设置。统一在`research.cpp`设置。

- 兼容 Qt5：保留并适配了 Qt5 专用分支与头文件。

#### 受影响的文件

- `src/Mogan/Research/research.cpp` —— 在创建 `QApplication` 前设置 AA 属性与 rounding policy。
- `src/Plugins/Qt/QTMApplication.hpp` —— 包含与 rounding policy 的平台保护。

#### 仍然存在的限制

1. 代码中仍存在以整数为单位的缩放假设（例如 `retina_factor` 作为 `int`，并在若干渲染路径中被直接乘用），导致只对 1× 和 2×（整数倍）有原生友好支持；125%/150% 等浮点缩放会被 round/回退，或由系统/Qt 在呈现时做硬件/显示层缩放，无法保证渲染像素精确对齐与清晰度。
2. `backingPixmap` 的分配、滚动偏移、无效区域计算等大量逻辑都在整数尺度上进行（`retina_factor * ...`），未以 `devicePixelRatioF()` 的浮点值进行一致转换。
3. 没有完整处理多显示器（不同 DPI）情况下的动态切换：当窗口从一个 DPI 的屏幕移到另一个屏幕时，当前代码缺乏统一的 reallocate/resize backing store 与重新渲染的流程。
