# [202_57] 调整超链接修改与打开逻辑

### 如何测试
1. 打开`TeXmacs/tests/tmu/202_57.tmu`
2. 点击“smart-ref:”和“reference:”后的链接应当直接转跳到对应位置
3. 点击“website link”和“file link”应当处于编辑文本状态，且提示“按住Ctrl并单击可打开”
4. 按住Ctrl并单击它们，应当转跳到网页和外部文件

## 2025/10/25

### What
对reference/smart-ref等文档内转跳的链接应当直接单击打开

而hlink这类外部文件/网页链接应当按住Ctrl单击打开，当单击时编辑文本且提示用户

### How
重点是如何判断转跳的位置在文件的内部还是外部

注意到所有内部的文件转跳的url中都会以"#"开头，而外部链接直接填的是文件相对路径或网页地址

故可以此为依据实现`link-contains-inner-link?`：
```scm
(tm-define (link-contains-inner-link? l)
  (:synopsis "Check if link list contains inner links (URLs starting with #)")
  (exists? (lambda (item)
    (exists? (lambda (vertex)
      (and (func? vertex 'url 1)
           (string-starts? (cadr vertex) "#")))
             (link-item-vertices item)))
           (ids->link-list l)))
```

修改`edit_interface_rep::mouse_select`中的处理逻辑：
```cpp
if (!is_nil (mouse_ids) && (mods & Mod2Mask) == 0 && !drag) {
 bool is_inner_link=
     as_bool (call ("link-contains-inner-link?", object (mouse_ids)));
 if (is_inner_link) {
   if (!(mods & ControlMask)) {
     call ("link-follow-ids", object (mouse_ids), object ("click"));
     disable_double_clicks ();
     return;
   }
 }
 else {
   if (mods & ControlMask) {
     call ("link-follow-ids", object (mouse_ids), object ("click"));
     disable_double_clicks ();
     return;
   }
   else call ("show-hlink-tooltip", object (mouse_ids));
 }
}
```

并在scheme中新增`show-hlink-tooltip`显示提示信息：
```scm
(tm-define (show-hlink-tooltip ids)
  (:synopsis "Show tooltip for hlinks")
  (when (nnull? ids)
    (close-tooltip)
    (delayed
      (:idle 10)
      (show-tooltip "link-tooltip" (cursor-tree) (utf8->cork "按住Ctrl并单击可打开")
                    "mouse-center" "prefer-mouse-top" "mouse" 3.0))))
```

## 2025/10/10

### What
之前插入 URL 超链接后，无法直接点击链接文字定位到链接并修改地址，需要手动将光标移动到链接末尾再调整位置，操作效率低。建议支持点击链接文字后直接进入编辑状态，类似 Office 等主流编辑器的行为，优化用户体验。

### How
打开链接的核心逻辑是`edit_mouse.cpp`中调用：
```cpp
call ("link-follow-ids", object (mouse_ids), object ("click"));
```

之前的判断是：
```cpp
if (!is_nil (mouse_ids) && (mods & (ShiftMask + Mod2Mask)) == 0 && !drag)
```
即按下Shift时才启动编辑（不打开链接）

现改为：
```cpp
if (!is_nil (mouse_ids) && (mods & Mod2Mask) == 0 && (mods & ControlMask) != 0 && !drag)
```
即只有按下Ctrl时才打开链接，未按下Ctrl时进入编辑状态