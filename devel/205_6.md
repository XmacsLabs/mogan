# 205_6 MuPDF：图形状态相关

## 如何测试
启用MuPDF后编译、运行，菜单栏点击插入->图片->绘制图形，可以正常绘制各种图形
打开测试文档`TeXmacs/tests/tmu/205_6.tmu`，判断其中的两个测试任务是否通过

## 2025/12/15 修复旋转的内容在滚动后不刷新的问题
经过调试，在滚动更新GUI触发的重绘制操作中，比较QT与MuPDF的工作流，发现两者区别在于最末端的image_box准备进行重绘`box_rep::redraw()`时，`ren->is_visible (x3 - delta, y3 - delta, x4 + delta, y4 + delta)`返回值不同，其中QT返回true，因而可以触发子组件重绘，而MuPDF中返回false，未能重绘，所以表现出滚动断层。

进一步发现，这是由于MuPDF中在`mupdf_renderer_rep::set_transformation (frame fr)`之后，clip参数范围未能更新（仍然是旋转前的可见范围）。进而解决方法如下：
1. 在`mupdf_renderer_rep::set_transformation (frame fr)`中适当位置重新加入`clip()`操作
2. 对应在`mupdf_renderer_rep::reset_transformation ()`中适当位置重新加入`unclip()`操作
3. 为避免绘制异常，在`transform_active`状态下，clip操作不下发给MuPDF底层，仅更新`renderer_rep`中的重要参数（cx1, cx2, cy1, cy2）


## 2025/10/09 修复旋转显示异常
### What
1. 引入新成员变量`transform_active`,指示当前是否处于 Transform 状态(可由rotate命令触发)
2. 修改`mupdf_renderer_rep::set_transformation (frame fr)`实现逻辑，将变换矩阵的逆保存在成员变量`transform_matrix`中，同时取消附加的`clip()`操作。
3. 修改`mupdf_renderer_rep::reset_transformation ()`实现逻辑，将`unclip()`操作替换为终止文本绘制和清除当前字体名。
4. 修改`mupdf_renderer_rep::begin_text ()`实现逻辑，由于在应用变换后，MuPDF内部会将传入的所有坐标均应用到转换矩阵，导致文本绘制位置异常。此处修改点是当处于 Transform 状态时，先将文本起始坐标左乘转换矩阵的逆矩阵`transform_matrix`，再将相乘结果传入MuPDF，进而得到正确的文本位置。

### Why
在启用MuPDF渲染器后，无法显示旋转后的文字

## 2025/07/21 修复裁剪区域设置异常
### What
问题根源在于，在绘制图形过程中，两个不同的`mupdf_renderer_rep`对象频繁、交替调用`set_clipping`函数，造成MuPDF内部图形状态管理异常，进而造成页面显示异常和崩溃。
1. 重写`mupdf_renderer_rep::set_clipping()`函数，重点解决不同`mupdf_renderer_rep`对象交替调用时，MuPDF图形状态能够统一。
2. 引入类静态变量`clip_active`，`clip_proc`统一管理裁剪设置的状态。
    - `clip_active`指示裁剪区域是否已被设置，在`mupdf_renderer_rep::end`中，裁剪设置会还原。
    - `clip_proc`保存上一次调用`set_clipping`函数的`mupdf_renderer_rep`对象中的MuPDF图形状态（`pdf_processor* proc`）地址，确保交替调用时，能够将上一次保存的图形状态顺利还原。

### Why
在启用MuPDF渲染器后，无法正常绘制图形，在绘制图形界面容易崩溃。
