# [202_9] 新增页码样式功能 & 修复页码显示

### 如何测试
1. 打开`TeXmacs/tests/tmu/202_9_1.tmu`，检查页码是否是：i ii o I II III 1 2 3 4 5（o表示不显示页码）
2. 打开`TeXmacs/tests/tmu/202_9_2.tmu`，检查页码是否是：1 2 3 4 5 VI VII VIII IX X XI
3. 打开`TeXmacs/tests/tmu/202_9_3.tmu`，检查页码是否是：1 2 3 4 5 6 7 8 9 10 11【在202_9_1.tmu的基础上只新增了一个1~11页的arabic覆盖，测试堆叠功能是否正常】
4. 打开`TeXmacs/tests/tmu/202_9_4.tmu`，检查页码是否是：o 1 2 3 4 5 6 7 8 9 10 【测试对旧文档使用page-first设置页码的兼容性，此处不应出现数字“0”】
5. 打开任意文档，在`文档->页面`中勾选`高级页码`后对页码样式进行任意多次自定义修改，检查页码渲染是否符合预期。

说明：一次修改即为`起始页`（`Applying from`，默认值为首页）到`结束页`（`Applying to`，默认值为尾页）的范围内以第`第一页`（`First page`）为起点开始编号、样式为`页码样式`（`Number style`）的页码样式覆盖，在按下`确定`后生效。在`文档->页面`中对其他页面样式操作时请取消勾选`高级页码`，这样在按下`确定`后不会修改到页码样式

## 2025/10/22

### What
1. 原实现没有对非正数页码做屏蔽，不美观
2. `文档->页面`中没有自定义页码样式的功能

### How
对于旧文档中使用`page-first`设置页码起始点后出现的非正数页面作出屏蔽：
```cpp
int current_page= N (pages) + 1 + page_offset;
if (current_page <= 0) env->write (PAGE_NR, "");
else env->write (PAGE_NR, as_string (current_page));
```

另外在后端`pager.cpp`中修改PAGE_THE_PAGE初始化逻辑，使得支持从`<\initial>`中读取自定义的页码样式宏`page-the-page`：
```cpp
style (PAGE_THE_PAGE)= env->read (PAGE_THE_PAGE);
```

以下重点介绍新功能的数据结构的实现（以`TeXmacs/tests/tmu/202_9_1.tmu`为例）：

利用`initial-set`在文档的`<\initial>`中插入`<associate|...|...>`标签：

```texmacs
<associate|page-the-page|<macro|<pn-g3>>>
<associate|pn-enable|true>
<associate|pn-g0|<macro|<value|page-nr>>>
<associate|pn-g1|<macro|<if|<or|<less|<value|page-nr>|1>|<greater|<value|page-nr>|2>>|<pn-g0>|<pn-l1>>>>
<associate|pn-g2|<macro|<if|<or|<less|<value|page-nr>|3>|<greater|<value|page-nr>|6>>|<pn-g1>|<pn-l2>>>>
<associate|pn-g3|<macro|<if|<or|<less|<value|page-nr>|7>|<greater|<value|page-nr>|11>>|<pn-g2>|<pn-l3>>>>
<associate|pn-l1|<macro|<if|<less|<pn-m1>|1>||<number|<pn-m1>|roman>>>>
<associate|pn-l2|<macro|<if|<less|<pn-m2>|1>||<number|<pn-m2>|Roman>>>>
<associate|pn-l3|<macro|<if|<less|<pn-m3>|1>||<number|<pn-m3>|arabic>>>>
<associate|pn-m1|<macro|<minus|<value|page-nr>|0>>>
<associate|pn-m2|<macro|<minus|<value|page-nr>|3>>>
<associate|pn-m3|<macro|<minus|<value|page-nr>|6>>>
<associate|pn-next|4>
```

初始时定义宏pn-g0表示默认配置，之后每新建一种样式即插入一个pn-gx（x>=1为index），利用if宏保留前置pn-g(x-1)的配置

- `<associate|pn-gx|<if|<or|<less|<value|page-nr>|X>|<greater|<value|page-nr>|Y>>|<pn-g(x-1)>|<pn-lx>>>>`，用于实现当前块作用范围的功能。\[X,Y\]表示需要应用的区间范围，范围外的使用pn-g(x-1)，范围内的使用当前配置pn-lx

- `<associate|pn-lx|<macro|<if|<less|<pn-mx>|1>||<number|<pn-mx>|S>>>>`，用于实现当前范围内页面的样式，**相对**页码小于1时不显示，页码样式为S（arabic、roman、Roman、hanzi等），相对页码数由pn-mx提供

- `<associate|pn-mx|<macro|<minus|<value|page-nr>|F-1>>>`，F表示当前区块的“第一页”，之前的页码全部屏蔽

- `pn-next`用于记录下一块样式的index，便于后续插入并更新

- `pn-enable`表示是否开启此页码样式编辑的功能，防止下次进入页面编辑但不进行页码操作时按下`确定`键后仍然更新到页码

- `page-the-page`为最终自定义宏入口，每次新增块样式后接入新的pn-gx

按照此规则可以一直往下堆叠，后面的样式不会影响到前面，可以反复多次覆盖修改页码
