# 201_11 数学补全\快捷键循环补全
## 如何测试
### 测试数学模式的Tab循环中 < tab 得到的列表中 ∈ 正常显示
1. 打开数学模式 $
2. 依次输入 `< tab`, 查看 ∈ 符号是否正常显示

### 测试转化box_widget内容为qwidget
我们使用辅助窗口来方便观察测试效果
1. 插入一个scheme块
2. 展示辅助窗口
```
(show-auxiliary-widget #t)
```
3. 运行
```
(set-auxiliary-widget (make-menu-widget '((tile 1 (link upper-greek-menu))) 0) "test")
```
或者更加基础的
```
(set-auxiliary-widget (make-menu-widget '(symbol "<alpha>") 0) "test")
```
4. 检查：右侧辅助窗口中正常出现数学符号的按钮

### 测试数学环境 Tab Cycling 补全项获取
注：这部分也有自动测试，在`201_11.scm`
1. 插入一个 Scheme 块
2. run
```
((lambda () (make 'math) (insert "in math") (math-variant "b") (show-auxiliary-widget #t))))))
```
3. 检查结果

### 测试数学环境 Tab Cycling 补全项的显示
0. 确保 Completion Style 为 Popup
1. 按`$`进入数学模式
2. 输入字符，例如`e`然后自由地按`tab`开始循环
3. 检查：QTMMathCompletionPopup弹出，且高亮正确
4. 继续输入字符，例如`=>`，然后自由地按`tab`开始循环
5. 检查：QTMMathCompletionPopup会自动消失，且按下`tab`之后再次打开
6. 将鼠标悬浮在任意选项上
7. 检查：是否有浮出的提示
8. 鼠标点击任意选项
9. 检查：最新插入的字符被替换成点击的选项
10. 鼠标点击任意非组件的位置
11. 检查：QTMMathCompletionPopup消失

### 测试补全项不会显示Error字样
0. 确保 Completion Style 为 Popup
1. 按`$`进入数学模式
2. 插入反引号
3. 按 Tab
4. 检查：QTMMathCompletionPopup不显示，且正常Tab循环

### 测试当补全项不合法时终端不会报出错误信息
0. 确保 Completion Style 为 Popup
1. 按`$`进入数学模式
2. 插入反斜杠 `\`
3. 按 Tab
4. 检查：QTMMathCompletionPopup不显示，且正常Tab循环，终端没有一场输出

### 测试循环过程中补全框不会闪烁
0. 确保 Completion Style 为 Popup
1. 按`$`进入数学模式
2. 插入 `e`
3. 自由地多次按 Tab
4. 检查：QTMMathCompletionPopup正常显示，且正常Tab循环，且循环过程中补全框没有闪烁现象

### 测试多标签页情况下的补全框使用
0. 确保 Completion Style 为 Popup
1. cmd-t 新建一个tab
2. 按`$`进入数学模式
3. 插入 `e`
4. 按 Tab 显示补全框
5. 使用鼠标切换到另一个标签页
6. 使用鼠标切换回先前的标签页
7. 继续插入字符，例如`e`
8. 按下 Tab
9. 检查：补全框重新出现了

### 测试数学补全框与数学工具栏的同时使用
0. 确保 Completion Style 为 Popup
1. 按`$`进入数学模式
2. 插入 `e`
3. 按 Tab 显示补全框
4. 在上方工具栏随意打开一个数学符号菜单，使用鼠标点击插入数学符号
5. 检查：QTMMathCompletionPopup消失，且数学符号正常插入

### 测试 Windows 平台没有空白窗口弹出
1. 在 Windows 平台中。按`$`进入数学模式
2. 输入 `d` 然后按住 `tab`
3. 持续一段时间
4. 检查：没有空白窗口弹出

### 测试 fix: `<` 和 `>` tab到显示 `<>` 的时候会出现叠影的问题
**请再次执行‘测试 Windows 平台没有空白窗口弹出’这个测试**
1. 按下`$`进入数学模式
2. 输入`<`
3. 多次按下`tab`，直到数学符号变成`<>`
4. 检查：补全框被隐藏

### 测试 fix: 数学补全意外显示
1. 按`$`进入数学模式
2. 输入`t tab`
3. 按`Enter`换行，同时离开了数学模式
4. 按`$`进入数学模式
5. 输入`t`
6. 检查：没有补全框出现

## 2025/12/01 仅做对 math-edit.scm 的代码格式化

## 2025/11/25 数学模式的Tab循环中 < tab 得到的 ∈ 无法显示
### What
修复 `< tab` 循环弹窗中首个候选被错误替换成《、`∈` 无法出现的问题
调整 Tab 循环候选顺序,始终是“当前符号 → `< tab` 结果 → `< tab tab` 结果 …”，并避免类型错误导致列表消失

### How
修改 `kbd-find-prefix-tab`, 仅收集基础前缀等于当前组合且以 `" tab"` 结尾的绑定,并按 Tab 个数升序排序,精准生成 Tab 循环候选


## 2025/10/28 [Jack Yansong Li] fix: 测试fail 的问题 
### What?
之前无法通过 CI, 原因是 `(kbd-find-prefix "e ")` 返回的是 逆 tab 循环的 的符号， 所以应当从最多tab的符号开始测试。

这边做的解决方案是将这个 kbd-find-prefix 函数内部数据进行排序


## 2025/09/28 fix: 数学补全意外显示
### What?
Bug: tab的这个备选项框会显示在一些奇怪的地方
https://gitee.com/XmacsLabs/mogan/issues/ICZWV6

### Why?
在 hide_math_completion_popup 时，状态量 last_comb (已更名为prev_math_comb)未设回空，导致下一次在数学模式输入相同按键时触发补全框的弹出。

## 2025/09/28 fix: `<` 和 `>` tab到显示 `<>` 的时候会出现叠影的问题
### What?
Issue: `<` 和 `>` tab到显示 `<>` 的时候会出现叠影的问题
https://gitee.com/XmacsLabs/mogan/issues/ICZLBE

### Why?
`this->hide()`在刷新关闭的时候执行，hide未导致UI刷新

## 2025/09/12 防止空补全窗口弹出
### What?
在Windows平台中，如果过快地切换补全，有概率造成补全窗口被当作独立窗口弹出。

Related Issue:
[Bug]： Windows上数学模式按d然后Tab三下后弹出窗口卡顿
https://gitee.com/XmacsLabs/mogan/issues/ICXJUH

### Why？
暂不清楚为什么 Windows 平台有概率不隐藏空的补全组件（窗口）。

### 如何解决？
在 cleanLayout 方法中额外加入对 layout 是否为空的判断，如果为空，隐藏窗口。

## 2025/08/20 使数学补全项显示更大
### What
- 将数学补全项与其他符号显示区分开来(symbol 和 symbol-completion)
- 给 make-menu-symbol 添加处理字体参数的逻辑。
- 将数学补全项的 box widget 的字边距 (dw) 设置为更低的值

### Why?
岩松建议放大数学补全的显示

## 2025/08/04 优化数学环境 Tab Cycling 补全项的显示
### What
- 解决了显示Error的问题
- 解决了终端报错的问题
- 解决了闪烁的问题
- 应用了共两处 suggested change.
- 优化了多标签页情况下补全框的使用
- 优化了补全框与数学工具栏的同时使用

## 2025/08/01 数学环境 Tab Cycling 补全项的显示
### What
- 添加了 Qt 组件 QTMMathCompletionPopup
- 添加了处理数学环境 Tab Cycling 补全项显示的键盘逻辑

## 2025/07/31 数学环境 Tab Cycling 补全项获取
### What
- 在`math-edit.scm`中添加了函数`math-tabcycle-symbols`用于在数学环境下获取 TabCycling 补全项
- 在`math-edit.scm`中添加了函数`math-variant`用于展示 TabCycling 补全项

目前TabCycling补全项由辅助窗口展示。将来会改成新的UI组件。

## 2025/07/29 支持转化box_widget内容为qwidget
### What
修改了as_qwidget中case menu_button情况下的逻辑，在没有精确匹配到type=xpm_widget或者text_widget的时候默认包装此widget的as_qaction为一个QToolButton作为返回的qwidget。

### Why
此修改是为了将box_widget作为qwidget显示。显示数学内容需要box_widget，而目前box_widget的只有as_qaction逻辑是正确的，as_qwidget逻辑是不正确的，得到的结果是一个空的QPushButton。

## 2025/07/29 给make-menu-symbol添加颜色参数
### What
- 给make-menu-symbol添加颜色参数
- 添加了新的case，`symbol*`创建红色的make-menu-symbol（以后的选中效果）

### 如何测试？
目前没有好的测试方法，就不写在上面了。这是因为作为widget显示menu-symbol的代码还没有合并。
可以手动修改
```
  (symbol (:string? :*)
          ,(lambda (p style bar?) (list (make-menu-symbol p style (color "black")))))
```
中的颜色，例如从`black`改成`red`。
然后进入数学模式，点击工具栏的数学符号随便打开一个菜单，观察数学符号的颜色

## 2025/07/28 快捷键前缀查找kbd-find-prefix的实现和测试
### What
实现了当前可用快捷键的前缀查找kbd-find-prefix，并添加了测试。

### Why
为将来在数学模式中补全提供底层接口。（数学模式的Tab Cycling是由快捷键定义的）

### 如何测试？
直接`xmake r 201_4`。这部分提供了自动测试，就不写到上面的测试章节中了。

