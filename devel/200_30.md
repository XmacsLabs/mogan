# 200_30: 添加webp图片支持

## 如何测试
### 测试用例1
- 测试图片位置:(https://gitee.com/XmacsLabs/mogan/blob/main/TeXmacs/tests/webp/new-mogan-512.webp)
    - 进行拖拽测试。
    - 使用插入图片测试。

### 测试用例2
直接打开 TeXmacs/tests/tmu/200_30.tmu

## 2025/11/14 粘贴WebP时保留后缀
### Why
- 早期剪贴板实现只保证了 PNG 流在内联对象里的互通性：`requests -> QImage -> save(&qbuf, "PNG") -> RAW_DATA` 这一套流程意味着所有来源（系统截图、浏览器复制等）都能在 `mupdf_load_and_parse_image(..., "png", ...)` 里被 MuPDF 直接读出来，因此“统一伪装成 png”省去了判断 Qt 支持矩阵、管理多种编码/压缩等麻烦。
- 但是 MuPDF 不能解码 webp，还是要通过 qt 来进行这个步骤，所以要单独保留 webp 的后缀

### How
- `Qt` 剪贴板导入流程不再把所有文件统一标成 `png`，遇到 `webp` 时会原样保留后缀。
- 这样 `mupdf_normal_image_size` 才能命中 WebP 的 Qt fallback，避免 `ramdisc://png` 报错。

## 2025/10/29 修复webp出现边缘彩色杂边
### How
使用`Format_RGBA8888_Premultiplied` 取代 `Format_RGBA8888`

### What
```
QImage::Format_RGBA8888
```

表示每像素 4 字节，内存顺序是 R, G, B, A（每个通道 8 位）。
这是“非预乘”（straight / unpremultiplied）格式：RGB 保存原始颜色值，Alpha 单独保存。用于表示图像颜色不受 alpha 修改的原始数据。

```
QImage::Format_RGBA8888_Premultiplied
```

同样是 R, G, B, A 的内存布局，但 RGB 已经被预乘 alpha：即存储的是 R' = R * A / 255、G' = G * A / 255、B' = B * A / 255。
这种格式适合直接进行合成（compositing），并且避免在每次绘制/混合时做乘法运算。

## 2025/10/28 webp支持的xmake构建定义调整
### What
1. 自行维护 `xmake/packages/q/qtbase/xmake.lua`
2. 在下载qt时，下载qtimageformats这个模块


这是核心的生效的代码：
```
        table.insert(aqt_args, "-m")
        table.insert(aqt_args, "qtimageformats")
```

## 2025/10/28 初步支持webp
