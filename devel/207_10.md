# 207_10 优化表格插入卡顿

## 2025/09/17 优化 `compute_env_rects` 实现

路径是 `./src/Edit/Interface/edit_interface.cpp`

单元测试运行方法

```

```

### Why

原代码对于表格选区矩形的计算，每次访问相邻单元格时都会再次调用 `find_check_selection` 并构造 `selection`，导致在表格较大时重复计算和对象创建过多，出现明显卡顿。

优化后的代码缓存每个单元格的 selection 结果，并在需要访问相邻单元格时直接复用缓存，避免了重复调用 `find_check_selection`,同时增加了对行宽信息的预处理。

### What

优化了 `edit_interface_rep::compute_env_rects` 的表格分支逻辑，主要包括：

1. 引入 `cell_cache` 缓存所有单元格的 `selection`，避免重复计算
2. 预先计算 `row_sizes`，简化后续相邻单元格的边界判断

### Result

在测试创建 30×30 的大表格并开启“显示单元格”选项时，矩形计算的耗时显著降低

优化前：
![](./image/207_10_com_1.png)

优化后：
![](./image/207_10_com_2.png)



## 2025/09/11 优化 `invalidate` 实现

路径是 `./src/Edit/Interface/edit_interface.cpp`

单元测试运行方法

```
xmake build invalidate_test

xmake run invalidate_test
```


### Why

原实现会对 `rectangles` 中的每一个矩形逐一调用 `invalidate`，在矩形数量较多时带来额外的开销。
新的实现通过求所有矩形的四个边界仅调用一次 `invalidate`，减少了函数调用次数和重绘区域处理次数。

虽然该处理会重绘一些不必要的区域，但根据测试结果和实际使用上看，其开销远远小于反复调用 `invalidate` 。

### What

优化了 `edit_interface_rep::invalidate(rectangles rs)` 的实现。

### result

在测试创建30*20的大表格时，`invalidate rectangles` 从 **\~17.7s/310次**提升至 **1ms/298次**。

优化前：
![](./image/207_10_invalidate_before.png)

优化后：
![](./image/207_10_invalidate_after.png)



## 2025/09/04 增加单元测试

路径是`./tests/Kernel/Types/rectangles_test.cpp`

运行方法 
```
xmake build rectangles_test

xmake run rectangles_test
```


### Why
保证优化后的正确性。

### What
增加单元测试


## 2025/09/02 优化 disjoint_union

### Why
原本是递归实现，耗时较多

### What
将 `disjoint_union`算法从递归改为迭代。

### result
热点基本消失。

优化前
![](./image/207_10_1.png)

优化后
![](./image/207_10_2.png)