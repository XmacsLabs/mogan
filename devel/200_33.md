# [200_33] 登陆按钮实现

## 具体实现
### 涉及文件
- `TeXmacs/plugins/account/progs/liii/account.scm` - 通过scheme处理token缓存
- `src/Plugins/Qt/QTMOAuth.cpp` - oauth2处理
- `src/Plugins/Qt/qt_tm_widget.cpp` - 主要实现逻辑
- `src/Plugins/Qt/qt_tm_widget.hpp` - 类定义和成员变量
- `src/Plugins/Qt/QTMOAuth.cpp` - OAuth2认证封装
- `TeXmacs/plugins/account/progs/liii/account.scm` - Token缓存管理
### 核心方法
- `setupLoginDialog()` - 初始化登录对话框UI
- `checkLocalTokenAndLogin()` - 检查本地token并处理登录逻辑
- `fetchUserInfo()` - 获取用户信息（支持模拟数据）
- `triggerOAuth2()` - 触发OAuth2认证流程
- `updateDialogContent()` - 更新对话框内容

## 2026/01/20 修改account.scm，统一成https://liiistem.cn官网入口

## 2026/01/08 解决自动登陆bug,因为官网路径换了

## 2026/01/07 新增跳转到购买页面的Scheme函数

## 2026/01/06 用户断网后，因网络问题不会清理`token`
###  What
- `token`刷新接口，取消因网络问题产生的清理`token`行为
- 用户信息获取接口，因网络问题，提示`网络有误，请稍后登录`
- 加快检查`token`是否过期方法的频率,每4分钟检查一次 -> 每一分半检查一次
- 增加打印日志，优化代码

## 2026/01/05 优化 account.scm
###  如何测试
- 使用`scheme ide`,输入`account.scm`相关命令测试

###  What
- 实现参数变量的变更
- 让`authorization-url`和`access-token-url`实时获取

## 2025/11/31 优化 TeXmacs/plugins/account/progs/liii/account.scm
###  What
- 优化代码
- 使用本地存储

## 2025/12/25 优化登陆模块的用户信息接口
### What
- 不再做判断逻辑,由服务端做展示逻辑,客户端直接展示即可
- 优化代码逻辑

## 2025/12/03 整理简化登录相关代码
### What
- 合并 loginActionButton 和 renewButton。
- 顺带解决登出后登录板块变大的问题：
   - 当用户点击“登出”时，代码会调用 updateDialogContent 函数来更新界面（隐藏“续费”按钮，显示“登录”按钮，更改文本等）。虽然界面元素的内容变了，但是弹窗窗口的大小并没有自动重新计算。这就导致了内容变少了，但窗口还是保持着登录状态下较大的尺寸，看起来布局就乱了。
- 使用 handleError，减少代码重复。

## 2025/12/03 黑夜模式适配

## 2025/12/03 修改登陆按钮的文本展示

## 2025/12/03 非社区版，ai按钮需要登录才能使用
### What
1. 社区版，ai按钮点击跳转官网
2. 非社区版(is_community=false)
   + 登录状态：ai按钮点击跳转官网
   + 非登录状态：ai按钮点击触发跳转官网登录

## 2025/12/03 新增检测是否登入的函数 logged-in?

## 2025/12/02 is_community配置的默认值放在 xmake/stem.lua 里面

## 2025/12/02 客户端oauth2的acllback回调端口实现动态端口

## 2025/12/01 登陆对话框新增`登出`和`续费`按钮

## 2025/11/28 网页端登陆后客户端登陆省去登陆信息填写

## 2025/11/28 登录按钮增加 from=login_button

## 2025/11/27 社区版点击登陆按钮跳转到官网，修复官网地址

## 2025/11/26 点击注册会员按钮跳转到官网自动登录
### What
1. 点击注册会员按钮跳转到官网自动登录
2. 调整`tokne`检查轮询时间，原先10分钟检查一次`token`5分钟内有没有到期，会和后台设置的过期时间撞上，所以调整下

## 2025/11/25 登录图标更换（大小适配windows）

## 2025/11/21 社区版点击登陆按钮跳转到官网
### What
- 实现社区版（默认`is_community=true`）点击登录按钮时跳转到官网的功能
- 区分社区版和商业版的登录行为，社区版引导用户访问官网
- 注意，需要修改`Github action`商业版的`cicd`代码

### How
- 在 `qt_tm_widget.cpp` 的 `checkLocalTokenAndLogin()` 方法中添加社区版判断
- 当 `is_community_stem()` 返回 true 时，执行跳转到官网的逻辑

## 2025/11/20 登录板块ui优化

## 2025/11/19 oauth2授权码模式支持refresh
### What
- 实现OAuth2授权码模式的token自动刷新机制
- 添加定时器定期检查token状态，自动处理过期和刷新

### How
- 刷新逻辑：
   - 当refresh_token不可用时，使用PKCE重新授权流程
   - 在`refreshToken()`方法中添加详细日志记录
   - 处理网络错误和服务器响应错误

## 2025/11/17 代码整理
### What
- 有部分代码比较混乱
- css部分直接放在cpp里了

## 2025/11/14 macos登陆按钮修复
### What
- 修复macOS平台上登录按钮显示异常问题
- 解决登录按钮在macOS上无法正确显示图标和状态的问题

### How
1.  通过调试发现macOS上登录按钮的图标路径和状态管理存在问题
2. **解决方案**:
   - 检查并修复图标资源文件的路径引用
   - 优化按钮状态切换逻辑，确保在不同平台下行为一致
   - 验证macOS特定的UI渲染问题

### Why
- 确保登录功能在Windows、Linux和macOS上都能正常工作

## 2025/11/14 oauth2登陆成功后回调页面自定义
### What
- 自定义OAuth2授权成功后的浏览器回调页面，提供更好的用户体验
- 将默认的空白页面替换为美观的提示页面，包含自动关闭功能

### How
1. `src/Plugins/Qt/QTMOAuth.cpp:43-52`
2. 使用`QOAuthHttpServerReplyHandler::setCallbackText()`方法直接设置自定义HTML内容

### Why
- 提供清晰的反馈，告知用户登录成功状态## next tips

## 2025/11/13 代码优化
### What
- 解决头文件混用问题：统一使用 `.hpp` 或 `.h` 文件扩展名
- 重构 `qt_tm_widget.cpp` 中的代码，将功能逻辑迁移到各自的组件类中

### How
1. **头文件规范化**：
   - 检查项目中 `.h` 和 `.hpp` 的使用情况
   - 根据项目规范统一文件扩展名

2. **代码重构**：
   - 将 `qt_tm_widget.cpp` 中的 OAuth2 相关逻辑迁移到 `QTMOAuth` 类
   - 将 UI 组件相关逻辑迁移到对应的组件类
   - 保持类的单一职责原则

### Why
- **代码规范**：统一头文件扩展名，提高代码一致性
- **可维护性**：通过代码重构，减少单个文件的复杂度，提高可读性和可维护性

## 2025/11/13 在macOS上修复构建失败的问题
## 2025/11/13 将测试及可替代数据迁移到scheme插件代码中
### What
- 将OAuth2配置和测试URL从C++硬编码迁移到Scheme配置文件中，实现配置集中管理
- 迁移的配置项包括：授权URL、令牌URL、客户端标识、作用域、端口、用户信息API URL、定价页面URL
- 将 `as_charp` 函数调用替换为 `c_string` 构造函数，改进内存管理

### How
1. 在`account.scm`中创建`account-oauth2-config`方法，通过key-value方式管理所有配置
2. 修改`QTMOAuth.cpp`和`qt_tm_widget.cpp`，使用`eval`和`call`从Scheme获取配置
3. Scheme配置文件中预留了生产环境、测试环境、本地环境的配置模板，便于切换
4. 使用`as_string`和`as_charp`进行Scheme对象到C++字符串的安全转换

### Why
- 所有OAuth2相关配置统一在Scheme文件中管理，便于维护和修改
- 通过注释/取消注释即可在不同环境（测试/生产/本地）间切换

## 2025/11/12 登陆按钮和下拉对话框组件
### What
- 完成了登录按钮相关的Qt框架开发，包括LoginButton和LoginDialog组件以及具体实现

### How
- LoginButton组件使用Qt PIMPL模式封装，支持四种状态图标管理
- LoginDialog组件实现弹窗式对话框，支持自定义内容区域
- fetchUserInfo后台接口对接集成

## 2025/11/11 Oauth2回调token缓存优化
### What
- Oauth2登陆流程回调的token保存至缓存文件
- 实现解耦，方便其他操作（比如登陆按钮）获取缓存的token

### How
1. account.scm 新增token操作方法，实现token缓存的多样化操作
2. QTMOAuth回调处调用scheme方法进行token保存

## 2025/11/06 清理无用代码

## 2025/11/05 新增 qtnetworkauth 模块，初步实现登录流程
###  What
1. 新增Qt NetworkAuth模块
2. 可以通过Scheme代码触发登录，并在终端中看到日志

### How
需要通过如下方法删除一下Qt的缓存：
``` bash
> xmake config --yes -vD
configure
{
    qt_sdkver = 6.8.3
    kind = static
    buildir = build
    mupdf = true
    windows_system_borders = false
    arch = x86_64
    ccache = true
    host = linux
    qt = /home/da/.xmake/packages/q/qt6base/6.8.3/7c1ea54729db483fa6eee7744bd4a333
    style_agent = false
    plat = linux
    mode = release
    ndk_stdcxx = true
}
> rm -rf ~/.xmake/packages/q/
> rm -rf .xmake
> xmake config --yes -vD
```