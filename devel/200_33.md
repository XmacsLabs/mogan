# [200_33] 登陆按钮实现

## 测试
### 测试环境准备
1. 启动项目
2. 点击右上角的登录按钮进行调试

### 测试数据（当前使用）
##### 测试数据
- **邮箱**: zhangjiadong2019@163.com
- **密码**: 123456

##### 模拟数据
- **位置**: `src/Plugins/Qt/qt_tm_widget.cpp` 
- **用户名**: jiadong
- **头像**: JD
- **账户ID**: A123456789

### 两种流程
1. 首次点击登录按钮：用户点击登录按钮 → 检查本地token缓存 → 无token → 显示登录对话框 → 用户点击登录按钮 → 触发OAuth2流程 → 浏览器打开认证页面 → 用户完成认证 → token回调存储 → 获取用户信息 → 更新对话框显示
2. 已登录状态点击：用户点击登录按钮 → 检查本地token缓存 → 有token → 使用token请求用户信息 → 更新对话框显示 → 显示用户信息和会员状态

### Oauth2功能测试
1. 插入 Scheme 会话
2. 在 Scheme 会话中运行 `(login)`
3. 缓存目录查看缓存文件，例如：~/.cache/MoganLab/2025.2.0-alpha2/account/token.scm

## 具体实现
### 涉及文件
- `TeXmacs/plugins/account/progs/liii/account.scm` - 通过scheme处理token缓存
- `src/Plugins/Qt/QTMOAuth.cpp` - oauth2处理
- `src/Plugins/Qt/qt_tm_widget.cpp` - 主要实现逻辑
- `src/Plugins/Qt/qt_tm_widget.hpp` - 类定义和成员变量
- `src/Plugins/Qt/QTMOAuth.cpp` - OAuth2认证封装
- `TeXmacs/plugins/account/progs/liii/account.scm` - Token缓存管理
### 核心方法
- `setupLoginDialog()` - 初始化登录对话框UI
- `checkLocalTokenAndLogin()` - 检查本地token并处理登录逻辑
- `fetchUserInfo()` - 获取用户信息（支持模拟数据）
- `triggerOAuth2()` - 触发OAuth2认证流程
- `updateDialogContent()` - 更新对话框内容

## next tips
- [✔] 将测试及可替代数据迁移到scheme插件代码中
- [✔] 代码优化，1 hpp和h混用，2 qt_tm_widget.cpp 里面的代码写太多，需要迁移到各自组件
- [ ] 多个stem同时启动，回调接口该如何设计
- [ ] oauth2回调页面优化

## 2025/11/13 代码优化
### What
- 解决头文件混用问题：统一使用 `.hpp` 或 `.h` 文件扩展名
- 重构 `qt_tm_widget.cpp` 中的代码，将功能逻辑迁移到各自的组件类中

### How
1. **头文件规范化**：
   - 检查项目中 `.h` 和 `.hpp` 的使用情况
   - 根据项目规范统一文件扩展名

2. **代码重构**：
   - 将 `qt_tm_widget.cpp` 中的 OAuth2 相关逻辑迁移到 `QTMOAuth` 类
   - 将 UI 组件相关逻辑迁移到对应的组件类
   - 保持类的单一职责原则

### Why
- **代码规范**：统一头文件扩展名，提高代码一致性
- **可维护性**：通过代码重构，减少单个文件的复杂度，提高可读性和可维护性

## 2025/11/13 在macOS上修复构建失败的问题
## 2025/11/13 将测试及可替代数据迁移到scheme插件代码中
### What
- 将OAuth2配置和测试URL从C++硬编码迁移到Scheme配置文件中，实现配置集中管理
- 迁移的配置项包括：授权URL、令牌URL、客户端标识、作用域、端口、用户信息API URL、定价页面URL
- 将 `as_charp` 函数调用替换为 `c_string` 构造函数，改进内存管理

### How
1. 在`account.scm`中创建`account-oauth2-config`方法，通过key-value方式管理所有配置
2. 修改`QTMOAuth.cpp`和`qt_tm_widget.cpp`，使用`eval`和`call`从Scheme获取配置
3. Scheme配置文件中预留了生产环境、测试环境、本地环境的配置模板，便于切换
4. 使用`as_string`和`as_charp`进行Scheme对象到C++字符串的安全转换

### Why
- 所有OAuth2相关配置统一在Scheme文件中管理，便于维护和修改
- 通过注释/取消注释即可在不同环境（测试/生产/本地）间切换

## 2025/11/12 登陆按钮和下拉对话框组件
### What
- 完成了登录按钮相关的Qt框架开发，包括LoginButton和LoginDialog组件以及具体实现

### How
- LoginButton组件使用Qt PIMPL模式封装，支持四种状态图标管理
- LoginDialog组件实现弹窗式对话框，支持自定义内容区域
- fetchUserInfo后台接口对接集成

## 2025/11/11 Oauth2回调token缓存优化
### What
- Oauth2登陆流程回调的token保存至缓存文件
- 实现解耦，方便其他操作（比如登陆按钮）获取缓存的token

### How
1. account.scm 新增token操作方法，实现token缓存的多样化操作
2. QTMOAuth回调处调用scheme方法进行token保存

## 2025/11/06 清理无用代码

## 2025/11/05 新增 qtnetworkauth 模块，初步实现登录流程
###  What
1. 新增Qt NetworkAuth模块
2. 可以通过Scheme代码触发登录，并在终端中看到日志

### How
需要通过如下方法删除一下Qt的缓存：
``` bash
> xmake config --yes -vD
configure
{
    qt_sdkver = 6.8.3
    kind = static
    buildir = build
    mupdf = true
    windows_system_borders = false
    arch = x86_64
    ccache = true
    host = linux
    qt = /home/da/.xmake/packages/q/qt6base/6.8.3/7c1ea54729db483fa6eee7744bd4a333
    style_agent = false
    plat = linux
    mode = release
    ndk_stdcxx = true
}
> rm -rf ~/.xmake/packages/q/
> rm -rf .xmake
> xmake config --yes -vD
```