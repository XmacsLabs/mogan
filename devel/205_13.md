# 205_13 

## 如何测试
1. 启用MuPDF渲染时，打开`TeXmacs/tests/tmu/205_13.tmu`文档，频繁上下滚动，观察线条粗细是否一致
2. 点击文件->预览，观察导出的PDF中线条粗细是否一致
3. 观察曲线边缘过渡是否平滑（可借助截图或系统放大镜）

## 2025/09/24 修复PDF相关渲染器图形绘制精度丢失问题

### What
本次修改同时分别应用于 MuPDF Render 和 PDFHummus Render：
1. 原本的`to_x(SI x)`（y坐标同理，后文省略），在计算坐标时，是两个整数相除，所以返回值设置成整数。
2. 为了提升绘图坐标的精度，新增同功能函数`double to_x_double (SI x)`，其内部实现参考依据是`src\Graphics\Renderer\renderer.cpp: 307`（QT渲染器绘图调用此处进行坐标转换）。
3. 两个渲染器实现类中，所有与绘图相关的函数：`line, lines, bezier_arc, polygon` 均采用`double to_x_double (SI x)`实现高精度坐标转换。

### Why
MuPDF渲染器绘制曲线边缘有毛刺感。

## 2025/09/19 修复PDF相关渲染器线条粗细设置问题
### What
本次修改同时分别应用于 MuPDF Render 和 PDFHummus Render。在`select_line_width(SI w)`函数中：
1. 不考虑当前线宽，始终写入`w`指令，设置PDF中的线宽。同时移除成员变量`current_width`。
2. 线宽单位换算中应将整型转换为浮点再进行运算，避免精读丢失。

### Why
修复PDF相关渲染器在实现线宽调整时的bug。

其触发原因是：当多个独立的 Graphic Box 存在于文档中时，Renderer 实现类由于保存了当前线宽（current_width），所以在渲染时只在第一个图形框绘制时设置了线宽，由于图形框绘制结束会清理绘图状态，导致后续图形框的线宽处于未被设置的状态。截取问题文档的PDF代码如下所示：

% 绘制第一个框中的直线
q
708 5903 1006 61 re
W
n
4.164062 w
0 0 0 rg
/GS1 gs
0 0 0 RG
/GS1 gs
2 J
1 j
q
2 J
1 j
738 5933 m
738 5933 l
1683 5933 l
S
Q
Q
% 上述所有设置的绘图状态均已清空

% 绘制第二个框中的直线
q
708 5748 1006 60 re
W
n
% 这里本应有设置线宽的命令
0 0 0 rg
/GS1 gs
0 0 0 RG
/GS1 gs
2 J
1 j
q
2 J
1 j
738 5777 m
738 5777 l
1683 5777 l
S
Q
Q
