# 204_18 优化 图片及题注 与 表格及题注

## 如何测试
1. 清除缓存 
  - Windows下是先在文件资源管理器里的地址输入框里输入 `%appdata%`，然后删除 `AppData/Roaming/MoganLab` 和 `AppData/Local/MoganLab`。
  - Linux下是删除 `.cache/MoganLab`。
  - macOS下是删除 `~/Library/Caches/MoganLab`。
2. 打开测试文档：Texmacs/tests/tmu/204_18.tmu
  - 分别测试最下面的工具栏里的功能
    - T(toggle name)
    - 123(toggle numbering)
    - 扳手里的 captions above
  - 其中 captions above 原先是 figure 和 table 同步切换的，现在是各自独立的
  - 切换文档语言为英文、中文，表格Caption的行为变化预期是中文在上，英文在下
3. 新建空白文档，重复第2步操作。

## 2025/12/28 修复Captions above导致的死循环崩溃
### What
每一个TMU文档的开头会有style项目，描述该文档需要导入的style-package，例如中文文档会使用chinese package。
但是，在上一次的修改中，chinese package内容中新增如下行：
```
<use-package|table-captions-above>
```
这意味着table-captions-above package会跟随chinese一同被**间接**导入。

在`table-captions-above.ts`中存在如下语句：
```
<assign|small-table-default-caps|<value|small-table>>
<assign|small-table|<macro|fig|cap|<with|render-small-table|<if|<equal|<value|table-captions-above>|true>|<value|render-small-table-captions-above>|<value|render-small-table-captions-below>>|<small-table-default-caps|<arg|fig>|<arg|cap>>>>>
```

首次间接导入过程中，由于先定义的`small-table-default-caps`，此时`small-table`宏内容为标准内建样式，此时无异常。

由于此时style清单中并未包含table-captions-above，当用户点击“扳手里的Captions above”时，软件会尝试**直接**导入 `table-captions-above` package，在第二次处理该包时，`small-table`值已被修改为新值，这时新的`small-table-default-caps`将会被赋予错误的内容（如下所示），导致后续排版引擎尝试构建时出现死循环（因为宏定义存在循环链 `A=B(A)` ）。
```
<assign|small-table-default-caps|<macro|fig|cap|<with|render-small-table|<if|<equal|<value|table-captions-above>|true>|<value|render-small-table-captions-above>|<value|render-small-table-captions-below>>|<small-table-default-caps|<arg|fig>|<arg|cap>>>>>
```

修改内容如下：
1. 删除`chinese.ts`中间接导入`table-captions-above`的语句。
2. 修改Scheme函数`set-document-language`，实现在中文环境中默认启用`table-captions-above`，当切换至其它语言时禁用。

### Why
See issue: [在中文文档中，table 使用 captions above 会死循环](https://github.com/XmacsLabs/mogan/issues/2279)

## 2025/12/15 分离 figure 和 table
### What
以前的 图片及题注 与 表格及题注 是在同一个逻辑下的，都是通过 new-figure 生成，但是figure的题注是在下面，table的题注是在上面，过去只是在宏定义上修改了 render-small-figure 和 render-big-figure，使用的时候自命名功能使用不了，上下位置切换两个会同步。