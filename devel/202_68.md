# 202_66 修改光标颜色，增加闪烁动画

## 如何测试
- 清除缓存 
  - Windows下是先在文件资源管理器里的地址输入框里输入 `%appdata%`，然后删除 `AppData/Roaming/MoganLab` 和 `AppData/Local/MoganLab`。
  - Linux下是删除 `.cache/MoganLab`。
  - macOS下是删除 `~/Library/Caches/MoganLab`。

- 直接就可以看到光标闪烁，清缓存是因为修改了颜色
- 测试中文输入法是否可以正常使用，如果有安装搜狗输入法也可以测试一下

## 2025/11/12
## What
参考其他软件，为光标添加闪烁效果，并修改颜色为黑色。

## How
- **复用主循环回调**：TeXmacs 的 GUI 主循环已经会在每次 `tm_server_rep::interpose_handler()` 中遍历所有视图、调用 `vw->ed->animate()`。我们直接在 `edit_interface_rep::animate()` 里插入光标闪烁逻辑，这样不需要自己建 Qt 定时器，也不用担心线程或生命周期问题。

- **维护闪烁状态**：在 `edit_interface_rep` 里增加了四个成员：
    - cursor_blink_visible（当前是否显示）
    - cursor_blink_active（是否启用闪烁）
    - cursor_blink_next（下一次翻转时间戳）
    - cursor_blink_period（闪烁周期，默认 500ms）

    `handle_keyboard_focus()` 里根据焦点开关这套状态，`suspend()/resume()`、`cursor_visible()`、`make_cursor_visible()` 这些会影响光标的地方也同步重置，确保每次用户操作后光标立即亮起并重新计时。

- **驱动与渲染**：`animate()` 每轮先调原来的动画任务，再根据时间戳判断是否需要翻转可见性。如果翻转，就局部 `invalidate` 光标矩形（用现有的 `invalidate(x1, y1, x2, y2)`），这样重绘开销最小。`draw_cursor()` 渲染前先看 `cursor_blink_active && !cursor_blink_visible`，若当前隐藏就直接返回，不去画那堆线。最终效果就是主循环驱动的闪烁动画，和已有的重绘逻辑完全融合。

## remark
- 目前分支的核心改动就是给原有光标绘制加了一个“闪烁”动画：`animate()` 驱动翻转状态、`draw_cursor()` 决定是否画线，其余渲染逻辑没动。所以从范围上看影响面非常集中。
- 动画依赖原有 GUI 主循环回调，没有新增线程或复杂依赖，和现有刷新机制完全一致，风险较低。
- 旧逻辑里输入法候选期（pre-edit）是通过 `temp_invalid_cursor` 等标志抑制光标的，我们在 `draw_cursor()` 里仍然优先检查那些条件；新引入的 `cursor_blink_active/visible` 只是在此之上“再遮一层”，并不改变 `pre-edit` 的判断。
- 由于没动输入法路径，也没有在 `pre-edit` 过程中强制亮起光标，所以两者不会相互踩踏。需要注意的是：假如某些输入法依赖光标常亮去对齐候选框，那么“光标闪烁”本身就会让它时亮时暗，但这是预期 UI 行为，不是冲突。