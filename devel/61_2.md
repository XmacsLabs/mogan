# 61_2 Python插件
## 如何测试
### conda的检测
在不同平台上安装 Anaconda3 并正确设置环境变量，创建一个虚拟环境，打开 **.\TeXmacs\tests\tmu\61_2_test_anaconda.tmu**，菜单栏点击 **插入->会话->Python** 选择 Python 环境，查看列表中是否正常显示创建的虚拟环境。将环境插入文档后，将光标移出 Python 对话框外，点击焦点工具栏中“session”左侧的“显示隐藏内容”，可以看到具体的虚拟环境名称。

### 未安装依赖的情况下能否使用Python基本功能，移除依赖未安装提示信息
菜单栏点击 **插入->会话->Python** 选择一个没有安装依赖的 Python 环境，先查看对于依赖未安装的提示信息是否混乱，然后执行简单的 Python 代码。

打开 **.\TeXmacs\tests\tmu\61_2_python_plugin.tmu** ，前往**1.1 未安装依赖库可以正常使用基本 Python 功能** 。菜单栏点击  **插入->会话->Python** 选择一个没有安装依赖的Python环境，然后执行简单的Python代码。

程序应正常输出，不会出现报错。

### 插件能力测试
打开 **.\TeXmacs\tests\tmu\61_2_python_plugin.tmu** ，菜单栏点击 **插入->会话->Python** 选择Python环境，根据文件中的代码进行 matplotlib 绘图、DataFrame 创建、sympy 符号渲染，查看绘图结果是否被正确渲染。 

### ?功能的移除
菜单栏点击 **插入->会话->Python** 选择 Python 环境，任选函数添加"?"并执行，Mogan 不会产生任何输出。

### 救生圈按钮移除
菜单栏点击 **插入->会话->Python** 选择Python环境，进入后工具栏中不应存在救生圈按钮。

### sympy字体问题
打开 **.\TeXmacs\tests\tmu\61_2_python_plugin.tmu** ，前往**5.3 字体测试**进行测试。


## 2025/11/18 修复Python插件启动时的判断逻辑 by Da Shen and Mingshen Chu
### What 
在 Mogan 启动时，会检查 Python 路径，只有检测到了 python.exe 才会启动 Python 插件，conda 本身携带了基础 Python 环境，但在安装了 conda 但没有安装 Python 的情况下 Python 插件不会启动。

### How
修改 **.\TeXmacs\plugins\python\progs\init-python.scm**，修改启动时的判断逻辑，Python 与conda 只要安装其一就可以启动。

修改 **.\TeXmacs\plugins\binary\progs\binary\conda.scm**，修改 **conda-env-python-list** 函数，使其可以检测 conda 的 base 环境。
打开 **.\TeXmacs\tests\tmu\61_2_python_plugin.tmu** ，前往对应章节，菜单栏点击 **插入->会话->Python** 选择Python环境，根据文件中的代码进行matplotlib绘图、DataFrame创建、sympy符号渲染，查看绘图结果是否被正确渲染。 


## 2025/11/18 修改sympy显示字体为roman
### What
原有 sympy 显示字体为 tt，应当改为 roman，更加美观。

### How
修改 .\TeXmacs\plugins\python\bin\python.pex，添加"\\rmfamily"。

## 2025/11/18 删除Python会话下工具栏的救生圈帮助按钮
### What
已不需要帮助文档，对应按钮应当删除。

### How
修改 .\TeXmacs\plugins\python\progs\python-menus.scm，删除相关代码。

## 2025/11/17 修复基础功能不能在不安装依赖的情况下使用的问题与依赖包提示信息混乱的问题
### What
用户如果不安装 matplotlib 等依赖，无法使用 Python 插件的基本功能。基本功能应在任何环境下都能使用。

用户未安装依赖，插入 Python 环境时的提示信息混乱，且存在多余信息。

### How
修改.\TeXmacs\plugins\python\bin\python.pex，在依赖未安装时不进入其判断逻辑，避免使用未被引入的包。

修改.\TeXmacs\plugins\python\bin\python.pex，添加换行符，删除冗余信息。

## 2025/11/17 修复Python插件不支持检测对所有用户安装的anaconda的问题
### What
当用户选择**为所有用户安装anaconda**的安装选项时，Python 插件无法正常识别 conda。

### How
修改 .\TeXmacs\plugins\binary\progs\binary\conda.scm ，在判断中添加新的路径。

## 2025/11/14 修复带空格的字符串无法在表格内正常显示以及输出表格中文乱码的问题
### What
在使用 Python 插件的过程中，如果输入的 dataframe 中的字符串包含空格，则其所在的单元格无法显示数据且无法编辑；如果包含中文，则中文会显示乱码。

### How
修改 .\TeXmacs\plugins\python\bin\python.pex 中的 **convert_dataframe_to_scheme_str() **函数，添加了对空格字符的转义。修改 .\TeXmacs\plugins\python\bin\tmpy\protocol.py，添加了 **flush_scheme_u8() **函数，并在 .\TeXmacs\plugins\python\bin\python.pex 中的 **flush_output()** 中进行调用，使表格能够正常输出中文。

## 2025/11/13 支持macOS平台anaconda的检测

## 2025/11/13 移除通过问号查看相关函数的文档的功能
### What
这个功能比较鸡肋，现在可以和大模型直接对话，得到很靠谱的回答。

### How
移除 .\TeXmacs\plugins\python\bin\python.pex 中的相关代码，移除 .\TeXmacs\plugins\python\progs\python-widgets.scm 文件，并移除 .\TeXmacs\plugins\python\progs\init-python.scm 中对 python-widgets 的依赖。

## 2025/11/13修复sympy的判断逻辑并优化代码结构
### What
部分被 dict 包含的 sympy 对象不能进入分支逻辑中，导致最终无法正确渲染数学符号。

### How
修改 .\TeXmacs\plugins\python\bin\python.pex 的 **flush_output()** 函数和 **is_sympy_object()** 函数，删除不必要的 **flush_sympy()** 函数。


## 2025/11/13 修复Axes3D对象不被识别为matplotlib对象的问题
### What
尝试输出 matplotlib 的3D对象时，axes 对象无法渲染，需要手动调用 .get_figure() 方法。

### How
修改 .\TeXmacs\plugins\python\bin\python.pex ，添加了新的判断逻辑。

## 2025/11/12 将图片的保存格式修改为pdf
### What
原有 png 格式不是矢量图，放大后会模糊。

### How
修改**flush_matplotlib_figure()**函数，将文件的保存格式修改为 .pdf。

## 2025/11/11添加对sympy的支持
### What
在 Mogan 编辑器中，当用户在内置 Python 插件中使用 sympy 进行数学符号输出时，无法渲染符号样式，仅会打印数据信息。

### How
修改 .\TeXmacs\plugins\python\bin\python.pex 的 **flush_output()** 函数，添加 sympy 的判断逻辑。实现了 **is_sympy_object()** 与 **flush_sympy()** 函数，封装逻辑，提升代码可读性。

## 2025/11/11 添加对anaconda的支持
### What
我们现在仅支持 miniconda，这个偏向于会使用命令行的用户。大部分基础 Python 用户，所使用的是 anaconda。因此需要添加对 anaconda 的支持。

### How
修改 .\TeXmacs\plugins\binary\progs\binary\conda.scm ，在其中添加默认的 anaconda 安装路径。

## 2025/11/10 添加对pandas DataFrame类型的支持
### What
在 Mogan 编辑器中，当用户在内置 Python 插件中使用 DataFrame 进行表格输出时，列索引与列不对齐，表格样式单一。

### How
修改 .\TeXmacs\plugins\python\bin\python.pex 的 **flush_output() **函数，添加DataFrame的判断逻辑。实现了 **convert_dataframe_to_scheme_str()** 函数，将 DataFrame 对象转换为对应的 scheme 代码字符串，调用 flush_scheme 进行表格绘制。

## 2025/11/7 追加对大部分matplotlib绘图使用场景的支持并优化代码结构
### What
在 Mogan 编辑器中，当用户使用内置 Python 插件进行 matplotlib 绘图时，绘图不能直接渲染，仅会打印数据信息。

### How
通过修改 .\TeXmacs\plugins\python\bin\python.pex 中的 **flush_output()** 等函数，实现了对大部分 matplotlib 绘图结果的直接渲染输出，目前支持的类型如下：

+ Figure
+ Axes
+ 继承自 Artist 的所有类型
+ 含有 matplotlib 绘图类型的 **list / dict / tuple** 容器

同时对代码结构进行了优化，实现了 **flush_matplotlib_figure()**、**is_matplotlib_object()**、**convert_matplotlib_object_to_figure() ** 函数，使代码更简洁易读。

## 2025/11/5 添加对Line2D类型的支持
### What
内置 Python 二进制插件不支持直接渲染 matplotlib.lines.Line2D 绘图。

### How
.\TeXmacs\plugins\python\bin\python.pex 缺少 matplotlib.lines.Line2D 绘图的判断与处理逻辑。

添加了新的判断逻辑，能够正确处理 Line2D 类型的绘图。

