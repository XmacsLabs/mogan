# 61_2 Python插件

## 如何测试

打开 **.\TeXmacs\tests\tmu\61_2_python_plugin.tmu** ，菜单栏点击 **插入->会话->Python** 选择Python环境，根据文件中的代码进行matplotlib绘图、DataFrame创建、sympy符号渲染，查看绘图结果是否被正确渲染。 

在不同平台上安装Anaconda3并正确设置环境变量，创建一个虚拟环境，打开**.\TeXmacs\tests\tmu\61_2_test_anaconda.tmu**，菜单栏点击 **插入->会话->Python** 选择Python环境，查看列表中是否正常显示创建的虚拟环境。

菜单栏点击 **插入->会话->Python** 选择Python环境，任选函数添加"?"并执行，Mogan不会产生任何输出。

## 2025/11/14 修复带空格的字符串无法在表格内正常显示以及输出表格中文乱码的问题

### What

在使用Python插件的过程中，如果输入的dataframe中的字符串包含空格，则其所在的单元格无法显示数据且无法编辑；如果包含中文，则中文会显示乱码。

### How

修改 .\TeXmacs\plugins\python\bin\python.pex 中的 **convert_dataframe_to_scheme_str() **函数，添加了对空格字符的转义。修改 .\TeXmacs\plugins\python\bin\tmpy\protocol.py，添加了 **flush_scheme_u8() **函数，并在 .\TeXmacs\plugins\python\bin\python.pex 中的**flush_output()**中进行调用，使表格能够正常输出中文。

## 2025/11/13 支持macOS平台anaconda的检测

## 2025/11/13 移除通过问号查看相关函数的文档的功能

### What

这个功能比较鸡肋，现在可以和大模型直接对话，得到很靠谱的回答。

### How

移除 .\TeXmacs\plugins\python\bin\python.pex 中的相关代码，移除 .\TeXmacs\plugins\python\progs\python-widgets.scm 文件，并移除.\TeXmacs\plugins\python\progs\init-python.scm中对python-widgets的依赖。

## 2025/11/13修复sympy的判断逻辑并优化代码结构

### What

部分被dict包含的sympy对象不能进入分支逻辑中，导致最终无法正确渲染数学符号。

### How

修改 .\TeXmacs\plugins\python\bin\python.pex 的 **flush_output()** 函数和 **is_sympy_object()** 函数，删除不必要的 **flush_sympy()** 函数。

## 2025/11/13 修复Axes3D对象不被识别为matplotlib对象的问题

### What

尝试输出matplotlib的3D对象时，axes对象无法渲染，需要手动调用.get_figure()方法。

### How

修改 .\TeXmacs\plugins\python\bin\python.pex ，添加了新的判断逻辑。

## 2025/11/12 将图片的保存格式修改为pdf

### What

原有png格式不是矢量图，放大后会模糊。

### How

修改**flush_matplotlib_figure()**函数，将文件的保存格式修改为.pdf。

## 2025/11/11添加对sympy的支持

### What

在Mogan编辑器中，当用户在内置Python插件中使用sympy进行数学符号输出时，无法渲染符号样式，仅会打印数据信息。

### How

修改 .\TeXmacs\plugins\python\bin\python.pex 的 **flush_output()** 函数，添加sympy的判断逻辑。实现了**is_sympy_object()**与**flush_sympy()**函数，封装逻辑，提升代码可读性。

## 2025/11/11 添加对anaconda的支持

### What

我们现在仅支持 miniconda，这个偏向于会使用命令行的用户。大部分基础Python用户，所使用的是 anaconda。因此需要添加对anaconda的支持。

### How

修改 .\TeXmacs\plugins\binary\progs\binary\conda.scm ，在其中添加默认的anaconda安装路径。

## 2025/11/10 添加对pandas DataFrame类型的支持

### What

在Mogan编辑器中，当用户在内置Python插件中使用DataFrame进行表格输出时，列索引与列不对齐，表格样式单一。

### How

修改 .\TeXmacs\plugins\python\bin\python.pex 的**flush_output()**函数，添加DataFrame的判断逻辑。实现了**convert_dataframe_to_scheme_str()**函数，将DataFrame对象转换为对应的scheme代码字符串，调用flush_scheme进行表格绘制。

## 2025/11/7 追加对大部分matplotlib绘图使用场景的支持并优化代码结构

### What

在Mogan编辑器中，当用户使用内置Python插件进行matplotlib绘图时，绘图不能直接渲染，仅会打印数据信息。

### How

通过修改 .\TeXmacs\plugins\python\bin\python.pex 中的**flush_output()**等函数，实现了对大部分matplotlib绘图结果的直接渲染输出，目前支持的类型如下：

+ Figure
+ Axes
+ 继承自Artist的所有类型
+ 含有matplotlib绘图类型的 **list / dict / tuple** 容器

同时对代码结构进行了优化，实现了**flush_matplotlib_figure()**、**is_matplotlib_object()**、**convert_matplotlib_object_to_figure()**函数，使代码更简洁易读。

## 2025/11/5 添加对Line2D类型的支持

### What

内置Python二进制插件不支持直接渲染matplotlib.lines.Line2D绘图。

### How

.\TeXmacs\plugins\python\bin\python.pex 缺少matplotlib.lines.Line2D绘图的判断与处理逻辑。

添加了新的判断逻辑，能够正确处理Line2D类型的绘图。

