# 205_3

## 如何测试
配置xmake启用mupdf，并编译：
```
xmake f --mupdf=true
xmake build stem
xmake run stem
```
打开任意测试文档，即可查看MuPDF的渲染效果
目前版本使用MuPDF渲染器的显示效果，与原版基本一致。


## 2025/09/05 MuPDF：修复插入错误图片时的崩溃
### What
崩溃原因：当插入错误图片时，`draw_scalable()`中调用`mupdf_load_image (u)`会返回空值，紧接着会调用`image_to_png(u, temp, w, h)`函数尝试将当前图片 u 转换为png格式存储至 temp 文件，当此函数中途失败时，temp文件并不存在，随后调用`fz_new_image_from_file()`加载temp文件，进而导致崩溃。

修复措施：
1. `image_to_png()`函数后，增加`exists (temp)`的判断，确保转换后文件存在再加载。
2. 此处的`fz_new_image_from_file()`增加`fz_try fz_catch`错误处理。

其他优化措施：
1. 将`image_to_png()`处理过程前移至`fz_image* mupdf_load_image (url u)`中完成。
2. `draw_scalable()`中未能加载图片时，调用`im->draw (this, x, y);`，与QT渲染器行为一致。

### Why
修复异常崩溃

## 2025/07/11 改进MuPDF渲染器
### What

1. 修改load_pdf_font()函数中加载字体的逻辑，在加载字体时传入`face_index`参数
2. 实现svg，pdf图片的加载功能，改善普通图片加载时的异常处理

参数说明：
在mupdf_load_image()中，加载svg、pdf图片时，需要将矢量图实例化为pixmap，因而需要设置缩放比例.
API接口`fz_scale (x_scale, y_scale);`即用于设置该缩放，缩放比越高，显示的图像越精细，本提交默认将其设置为200%。
在MacOS开启HiDPI x2倍缩放的显示器上，能够清晰显示图片。

### Why
改进MuPDF渲染器