# 204_1 CJK标点符号间距调整功能实现
## 如何测试
打开`204_1.tmu`，查看里面标点符号的压缩情况。

## 2026/01/06
### What
插入中文的双引号和中文的单引号，在插入的时候，排版引擎里面是`<#2018>`, `<#2019>`, `<#201C>`，`<#201D>`，但是保存到TMU文档，重新加载之后，会变成Cork编号，比如双引号分别是16进制的10和11。

## 2025/11/17

### Why
在TeXmacs中处理中日韩（CJK）文本时，标点符号的间距调整是一个重要的排版需求。特别是对于夹注符号（如括号）和普通标点符号之间的间距，需要根据不同的上下文进行智能调整，以符合中文排版的规范和美观要求。现有的自动间距功能无法满足这种精细的标点符号间距控制需求。https://www.w3.org/TR/clreq/#punctuation_width_adjustment 参考 6.3.2 标点符号的宽度调整

### How
分为以下几类情况：
1. 右侧有调整空间的符号（不包括右夹注符号），下一个（右侧）符号是夹注符号，调小右侧空间
    1.1 如果下一个夹注符号是右夹注符号，那么调小右侧空间 0.5 字宽
    1.2 如果下一个夹注符号是左夹注符号，那么调小右侧空间 0.25 字宽
2. 右夹注符号，只有右侧有调整空间，下一个（右侧）是符号，调小右侧空间
    2.1 如果下一个符号是左侧有调整空间的符号（只有左夹注符号），那么调小右侧空间 0.25字宽
    2.2 如果下一个符号是其他符号，那么调小右侧空间 0.5字宽

3. 左夹注符号（左侧可调整符号只有左夹注符号），只有左侧有调整空间，上一个（左侧）是符号，调小左侧空间
    3.1 如果上一个符号是右侧有调整空间的符号（包括右夹注符号），那么调小左侧空间 0.25字宽
    3.2 如果上一个符号是其他符号，那么调小左侧空间0.5字宽  

### What
本次修改实现了以下功能和影响：

#### 解决的问题
1. **CJK标点符号间距智能调整**：解决了中文排版中标点符号间距不符合规范的问题
2. **夹注符号特殊处理**：针对括号等夹注符号提供了专门的间距调整逻辑
3. **上下文感知调整**：根据符号在行中的位置（行首、行尾、中间）和相邻符号类型进行差异化调整

#### 系统影响范围
1. **Typeset模块扩展**：扩展了box基类接口，影响所有box子类
2. **段落处理增强**：增强了lazy_paragraph的处理能力，增加了新的数据结构和算法
3. **文本框功能增强**：为text_box添加了kerning收缩功能

#### 测试验证
添加了测试文件`TeXmacs/tests/tmu/204_1.tmu`，包含以下测试场景：
- 行首和行尾夹注符号的0.5字宽调整
- 普通符号后跟左夹注符号的1.5字宽调整
- 夹注符号后跟普通符号的1.5字宽调整
- 连续符号的混合字宽调整（前两个1字宽，后续1.5字宽）

#### 兼容性考虑
1. **向后兼容**：新添加的虚函数在基类中提供默认实现，不影响现有代码
2. **性能影响**：新增的标点符号识别和调整逻辑仅在CJK语言环境下启用
3. **可扩展性**：通过哈希集合设计，便于后续添加新的标点符号类型

这次实现为TeXmacs的CJK排版功能提供了重要的增强，特别是在标点符号间距的精细控制方面，为用户提供了更加专业和美观的中文排版体验。