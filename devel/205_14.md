# 205_14 修复converter结构在文档导航时的状态切换问题

## 如何测试

打开`TeXmacs/tests/tmu/205_14.tmu`

点击`pagedown`（下一页）和`pageup`（上一页），查看converter结构是否保持不变（不会展开/折叠）

## 2024/05/14

### Why
在Mogan编辑器中，当用户在包含converter结构（用于代码输入输出转换的特殊结构）的文档中进行导航时，converter的展开/折叠状态会被自动切换，导致用户之前的选择状态丢失。这影响了用户的编辑体验，特别是在需要频繁导航并保持converter状态的场景下。

### How
通过修改`fold-edit.scm`文件中的两个关键函数，实现了对converter结构的特殊处理，避免其状态在导航过程中被自动改变：

**1. 修改`dynamic-operate-sub`函数**
```scheme:TeXmacs/progs/dynamic/fold-edit.scm
(define (dynamic-operate-sub t mode)
  (if (tree-compound? t)
      (for-each (lambda (x) (dynamic-operate x mode)) (tree-children t)))
  (cond ((and (converter-context? t) (toggle-first-context? t))
         ;; 对于converter-input，不进行折叠或展开操作
         #f)
        ((and (converter-context? t) (toggle-second-context? t))
         ;; 对于converter-output，不进行折叠或展开操作
         #f)
        ((toggle-first-context? t)
         (cond ((== mode :var-last)
                (tree-insert-node! t 0 '(traversed)))
               ((in? mode '(:unfold :expand :var-expand :last))
                (alternate-toggle t))
               ((in? mode '(:fold :compress :var-compress :first))
                #f)))
```

**2. 修改`dynamic-traverse`函数**
```scheme:TeXmacs/progs/dynamic/fold-edit.scm
        ((and (converter-context? t) (toggle-first-context? t))
         ;; 对于converter-input，直接遍历其内容而不切换状态
         (dynamic-traverse (tree-ref t 1) mode))
        ((and (converter-context? t) (toggle-second-context? t))
         ;; 对于converter-output，直接遍历其内容而不切换状态
         (dynamic-traverse (tree-ref t 2) mode))
        ((toggle-first-context? t)
         (or (dynamic-traverse (tree-ref t 0) mode)
             (dynamic-traverse-folded t mode)))
```