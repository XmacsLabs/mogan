# [202_58] 调整批注等tooltip刷新逻辑

### 如何测试
1. 点击`⊕`中进入`实用`，加载`comment`和`preview-ref`模块
2. 打开新增的测试文档（`Texmacs/tests/tmu/202_58.tmu`）
3. 将光标定位到注释上使得注释tooltip出现，对页面进行缩放、滚动等操作观察tooltip位置和大小是否及时得到更新
4. 将光标放在reference引用上使得tooltip出现，对页面同样操作，观察其位置是否及时更新而没有滞留

## 2025/10/16

### What
新增对`preview-ref`的tooltip更新支持

### How
与`comment-tooltip`的更新处理类似，增加`modify-ref-tooltip`和`update-ref-tooltip`函数，并在`apply_changes()`中调用

## 2025/10/15

### What
折叠批注的气泡在页面发生变化（包括缩放、滚动、窗口切换）时，仍保持在原位，没有及时更新位置和大小

### How
在`apply_changes()`中新增争对于折叠批注气泡的检测，若页面出现缩放、滚动或窗口切换时更新`comment tooltip`：
```cpp
if ((env_change & (THE_ENVIRONMENT + THE_EXTENTS + THE_FOCUS)) ||
		new_visible != last_visible)
	call ("modify-comment-tooltip");
```

在scheme层加入`modify-comment-tooltip`函数，当且仅当`comment tooltip`出现时更新其位置：
```scheme
(tm-define (modify-comment-tooltip)
  (when (and (defined? 'update-comment-tooltip)
             (procedure? update-comment-tooltip))
    (update-comment-tooltip)))
```

同时对`update-comment-tooltip`的逻辑进行修改，只要气泡存在，那么在更新时必然清除原气泡并重新绘制气泡大小和位置：
```scheme
(tm-define (update-comment-tooltip)
  (let* ((id (comment-id (cursor-tree)))
         (tip (comment-preview (cursor-tree))))
    (if (and id tip)
        (begin
          (close-tooltip)
          (delayed
            (:idle 1)
            (show-tooltip id (cursor-tree) tip
                          "auto" "auto" "keyboard" 2.0)))
        (close-tooltip))))
```
防止气泡看起来像一个“贴图”