# [202_14] 修改关闭对话框的逻辑

## 如何测试
对打开的文档进行编辑，从`文件->关闭文档(Ctrl+W)`或标签栏关闭文档。
对比main分支，之前应弹出“该文件尚未保存.是否真要关闭它?”，选*是*则关闭，选其它则取消。
现在应弹出“是否保存对该文档的更改?”，选*保存*则保存（如果是新建的文档，另存为），选*不保存*则不保存关闭，选其它则取消。
目前从右上角关闭软件，只询问是否保存当前文档，可保存的文档会保存，新建的文档则会丢失。

## 2025/09/26
### What
关闭对话框应询问是否保存，而非是否关闭

### How
- 新建了 `save-buffer-as-simple-save` 相关的一套基于 tm-files.scm 的 `save-buffer-as` 简化的保存函数（因为 `tm-files.scm` 调用了 `tm-server.scm`，再调用会循环调用）
- 新建了 `confirm-close-dialog` 函数，用于取代原先的通用对话框；UI和获取文件名的内容仍需跟进
- 修复了文件原先的小问题
  - `(pred? (lambda (fun) (not (not (property fun :arguments)))))` -> `(pred? (lambda (fun) (property fun :arguments)))`

目前针对不保存、已有文件保存没有问题，但是针对草稿文件保存需要再进行优化
- 因为针对草稿文件保存，实际是执行了另存为，而 `save-buffer-as-simple-save` 函数是异步的，因此不会执行回调关闭，文件另存为完就会停止，需要手动关闭（这个不会产生恶性bug，而且效果是可以接受的）
- **针对多个草稿文件时关闭窗口，会触发 `safely-kill-window` 或 `safely-quit-TeXmacs`（根据窗口数），但是目前只会执行一次保存，即保存当前活跃的标签，其他的文件会丢失，这个是需要修复的**