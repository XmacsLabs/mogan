# 204_21

## 如何测试
打开测试文档`TeXmacs/tests/tmu/204_21.tmu`，程序不崩溃正常渲染即通过

## 2025/12/17 标宽表格整体高亮导致崩溃
### What
在表格环境中启用高亮后，相关配置会写入编辑器环境env[ATOM_DECORATIONS]，其中主要内容为设置单元格背景为高亮颜色，但是由于在排版处理中未能及时移除该配置项，最终造成无限递归。递归调用堆栈如下（从上往下调用执行）：
```
MoganSTEM.exe!cell_rep::finish_horizontal() Line 436 (src\Typeset\Table\cell.cpp:436)
...
MoganSTEM.exe!lazy_paragraph_rep::line_end(space spc, int penalty) Line 918 (src\Typeset\Line\lazy_paragraph.cpp:918)
...
MoganSTEM.exe!typeset_as_table(edit_env env, lolly::data::lolly_tree<observer> t, list<int> ip) Line 1048 (src\Typeset\Table\table.cpp:1048)
...
MoganSTEM.exe!cell_rep::finish_horizontal() Line 436 (src\Typeset\Table\cell.cpp:436)
...

```
造成无限递归的关键代码如下：
```C++
lazy_paragraph_rep::lazy_paragraph_rep (edit_env env2, path ip) ... {
  ...
  init_decs= env->read (ATOM_DECORATIONS);
  ...
}

void
lazy_paragraph_rep::line_end (space spc, int penalty) {
  if (N (items) == 0) return;
  if (N (decs) == 0 || decs[0][1] == tree (DATOMS)) {
    tree dec= init_decs;
    if (N (dec) > 0) decs= ::append (tuple ("0", dec), decs);
    init_decs= tree (DATOMS);
  }
  if (N (decs) != 0) handle_decorations ();
  ...
}
```
注意到数据流`env[ATOM_DECORATIONS] -> init_decs -> decs`，由于在整个过程中env[ATOM_DECORATIONS]没有任何变化，所以该循环链条无法中断，造成无限递归。

经过综合分析与审慎考虑，决定在cell创建时消除env[ATOM_DECORATIONS]，彻底终结递归循环。
```C++
void
cell_rep::typeset (tree fm, tree t, path iq) {
  ...
  lz= make_lazy (env, t, iq);
  env->write (ATOM_DECORATIONS, DATOMS);
  ...
}
```
修改的位置只会在标宽表格排版中命中，且清除操作位于单元格中子组件（lz）初始化完成之后，不会影响子组件排版。

### Why
在标题环境下，整体应用高亮会导致程序陷入无限递归，最终因栈内存耗尽而崩溃。
