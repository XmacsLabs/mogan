# 201_26 无边框标签栏

## 如何测试

- 双击边框，是否可以正确的切换 最大化/还原
- 在全屏下长按拖动顶部标签栏，测试窗口是否会从 最大化-> 还原
- `ctrl + n` 新建标签，一直加加到满，测试是否会和右侧按钮重叠
- 拖拽标签栏，当窗口拖拽到屏幕不同边缘时，会显示相应的布局预览
- 删除缓存文件，查看 menutoolbar 是否在标题栏下面

## 主要涉及文件
- QTMTabPage.cpp
- QTMTabPage.hpp
- qt_tm_widget.cpp
- qt_tm_widget.hpp

## 2025/10/22 liii-night.css添加
为liii-night主题添加css

## 2025/10/22 菜单栏位置调整
锁定 menutoolbar

## 2025/10/21 新增标签页按钮

### What?
- 在最右侧标签页后面新增一个 `+`按钮
- 调整标签页文本和按钮垂直居中

## 2025/10/21 窗口拖拽到屏幕边缘的悬停效果

### What?
实现了 Windows 风格的窗口拖拽悬停效果，当窗口拖拽到屏幕不同边缘时，会显示相应的布局预览：

**屏幕边缘拖拽效果：**
- 拖拽到左侧边缘：窗口将占据左半屏
- 拖拽到右侧边缘：窗口将占据右半屏

**屏幕角落拖拽效果：**
- 拖拽到左上角：窗口将占据左上四分之一屏幕
- 拖拽到左下角：窗口将占据左下四分之一屏幕
- 拖拽到右上角：窗口将占据右上四分之一屏幕
- 拖拽到右下角：窗口将占据右下四分之一屏幕

**顶部中央拖拽效果：**
- 拖拽到顶部中央：显示最大化按钮悬停选择，其余区域为全屏预览

### How?

回退前两次关于鼠标事件的修改，删去在QTMTabPage中多余的函数：mousePressEvent、mouseMoveEvent、mouseReleaseEvent

**移除 `outAgent->setHitTestVisible(tabPageContainer, true)` 的原因：**

1. **Windows Snap 功能依赖**：Windows 的 Snap 功能（窗口拖拽到屏幕边缘自动停靠）依赖于系统能够正确识别窗口的可拖动区域。这通过 `WM_NCHITTEST` 消息返回 `HTCAPTION` 来实现。

2. **Hit Test 可见性的冲突**：当整个标签页容器被设置为 hit test 可见时，鼠标在标签页区域的所有事件都会被标签页容器处理，Windows 系统无法接收到 `HTCAPTION` 响应，因此无法触发 Snap 功能。

3. **解决方案**：
   - **移除容器级别的 hit test 可见性**：让标签页容器的空白区域允许 Windows 系统处理拖动事件
   - **为单个标签页设置 hit test 可见性**：在标签页创建后为每个标签页单独设置 hit test 可见性，这样标签页仍然可以接收鼠标事件进行拖拽操作
   - **为 Pin 按钮单独设置 hit test 可见性**：Pin 按钮不是标准系统按钮，需要手动设置 hit test 可见性才能接收鼠标事件

**修改内容：**
- 移除了 `qt_tm_widget.cpp` 中的 `outAgent->setHitTestVisible(tabPageContainer, true)`
- 在 `QTMTabPageContainer` 中添加了 `setHitTestVisibleForTabPages` 方法
- 在标签页创建后调用该方法为每个标签页设置 hit test 可见性
- 为 Pin 按钮单独设置了 hit test 可见性

**效果：**
- 标签页功能正常：标签页仍然可以拖拽、点击、关闭
- Windows Snap 功能恢复：窗口可以拖拽到屏幕边缘自动停靠
- 所有系统按钮正常工作：包括 Pin 按钮在内的所有按钮都可以正常点击

## 2025/10/20 长按事件优化，右侧为按钮留空
### What?
- 原先在长按拖动时设置了3px的移动检测，但是实际使用经常会发生触发失败，因此去掉这个检测，只要拖动就直接触发还原。
- 原先特别多的标签页会重叠在右侧按钮上，现在为标签页栏的右侧加上预留空间。

## 2025/10/17 修复 Windows/Linux 边框鼠标事件的问题
作者是 Yifan Lu
### What?
修改之前的问题：
- 长按拖动时不会从最大化还原再拖动
- 双击边框不会 最大化/还原

修改后：
- 双击标签栏空白处（非按钮区域）：窗口会在最大化/还原之间切换（不影响全屏）。
- 长按并拖动标签栏空白处：如果窗口是最大化，首次拖动时会自动还原，然后继续拖动，拖动锚点会自动重算，体验更平滑。
- 只有在真正的空白区域才会触发上述行为，点击标签按钮不会影响标签自身的拖动/关闭等逻辑。
- 相关逻辑已在 QTMTabPageContainer 内实现，避免与标签按钮冲突。
- 该行为与原生 Windows/Linux 标题栏一致，方便用户习惯迁移。


## 2025/10/17 修复 Linux 标签页样式问题

## 2025/10/14 在 Windows/Linux 平台实现自定义无边框标签栏
### What?
- 修改 `qt_tm_widget.cpp`和`qt_tm_widget.hpp`,删除大量无用的if-else语句，简化功能栏高度代码，并引入 windows/linux 使用的边框按钮设置，在 `liii.css`中设置边框栏
- 删除 qwindowkitty/src/quick ，这是用于qt quick，项目不使用
- 添加 qwindowkitty/src/styles 和 qwindowkitty/src/ui/widgetframe
- 优化 src/Plugins/Qt/QTMTabPage.cpp ，效果更好

bug待修复：

1. 按钮放大缩小不是很好用
2. 拖动边框会有问题
3. 菜单栏位置不对

## 2025/10/13 在 Windows 平台修复重复编译的问题
### What?
- 配置头 qwkconfig.h：现在先读旧文件，内容没变就不重写，这样不会刷新时间戳。
- 头文件复制：把 os.cp 换成 os.vcp，这个命令只有发现目标文件不同才会覆盖，避免每次都把拷贝目标的时间戳刷新。

## 2025/10/10 在 macOS 平台正确构建无边框依赖
## 2025/10/08 在 Linux 平台开启多标签页在顶部
## 2025/10/08 在 Linux 平台上无边框依赖的引入和构建
## 2025/10/07 在 `qt_tm_widget.cpp` 添加 else 语句，使非mac平台也会正常创建 tab 页容器
## 2025/10/06 在 macOS 平台上实现无边框标签栏
## 2025/10/05 在 macOS 平台上添加 QWindowKit 依赖
## 2025/10/05 在 macOS 上把菜单栏放到工具栏中
### What?
添加了条件编译在 macOS 上把菜单栏放到工具栏中

### Why?
为在 macOS 上应用 QWindowKit 实现无边框做准备

## 2025/10/05 美化的标签栏
### What?
重新实现了 QTMTabPageContainer，与相关的大量方法，使标签栏更加美观
