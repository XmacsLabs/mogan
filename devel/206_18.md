# 206_18 ä½¿å­—ä½“å¤§å°æ”¯æŒ0.5çš„å€æ•°

## å¦‚ä½•æµ‹è¯•
1. è¿è¡ŒC++å•å…ƒæµ‹è¯•
```bash
xmake b font_size_test
xmake r font_size_test
```
2. æµ‹è¯•æ–‡æ¡£ï¼šTeXmacs/tests/tmu/206_18.tmu

## 2026/01/28 ä½¿å­—ä½“å¤§å°æ”¯æŒ0.5çš„å€æ•°
### What
- ä¸»è¦å°†åŸæ¥`font_size`ç›¸å…³çš„ä»£ç ä»`int`æ”¹ä¸º`double`
- æ•ˆæœä¸¾ä¾‹ï¼š10.51ä¼šå››èˆäº”å…¥ä¸º10.5ï¼›10.75ä¼šå››èˆäº”å…¥ä¸º11

> ä¸‹é¢ä¸ºè¯¦ç»†çš„é¡¹ç›®è¿›åº¦æƒ…å†µï¼Œå› ä¸ºæœ¬æ¬¡ä¿®æ”¹èŒƒå›´æ¯”è¾ƒå¤§ï¼Œå› æ­¤ä¿ç•™

# ç¬¬ä¸€é˜¶æ®µå®Œæˆæƒ…å†µï¼šä»£ç åˆ†æ

  1. æ ¸å¿ƒæ•°æ®ç»“æ„ç¡®è®¤

  - å…³é”®æ–‡ä»¶ï¼šsrc/Graphics/Fonts/font.hpp:57 ç¡®è®¤äº† font_rep ç»“æ„ä½“ä¸­çš„ SI size; å­—æ®µ
  - å½“å‰ç±»å‹ï¼šSI æ˜¯ int ç±»å‹ï¼ˆæœ‰ç¬¦å·æ•´æ•°ï¼‰ï¼Œå®šä¹‰åœ¨ 3rdparty/lolly/Kernel/Abstractions/minmax.hpp

  2. éœ€è¦ä¿®æ”¹çš„å…³é”®å‡½æ•°ç­¾ååˆ†æ

  é€šè¿‡ grep å‘½ä»¤å‘ç°ä»¥ä¸‹å…³é”®æ¨¡å¼ï¼š

  int sz å‚æ•°ä½¿ç”¨æƒ…å†µï¼š
  src/Graphics/Fonts/font.hpp:font virtual_font (font base, string fam, int sz, int hdpi, int vdpi, bool ext);
  src/Graphics/Fonts/font.hpp:font find_font (string family, string variant, string series, string shape, int sz, int dpi);
  src/Graphics/Fonts/font.hpp:font smart_font (string family, string variant, string series, string shape, int sz, int dpi);
  src/Graphics/Fonts/smart_font.hpp:font smart_font_bis (string f, string v, string s, string sh, int sz, int hdpi, int vdpi);
  src/Graphics/Fonts/font.cpp:int script (int sz, int level);

  get_int(FONT_BASE_SIZE) ä½¿ç”¨æƒ…å†µï¼ˆéœ€è¦æ”¹ä¸º get_doubleï¼‰ï¼š
  src/Typeset/Env/env_semantics.cpp:fn_size= (int) (((double) get_int (FONT_BASE_SIZE)) * get_double (FONT_SIZE) + 0.5);
  src/Typeset/Env/env_length.cpp: (get_int (FONT_BASE_SIZE) * magn * inch * get_double (FONT_SIZE)) / 72.0;
  ï¼ˆå…±æ‰¾åˆ°7å¤„ä½¿ç”¨ï¼‰

  fn->size ä½¿ç”¨æƒ…å†µï¼ˆéœ€è¦æ·»åŠ ç±»å‹è½¬æ¢ï¼‰ï¼š
  src/Typeset/Boxes/Composite/script_boxes.cpp:SI top= max (lo->y2, fn->y2 * script (fn->size, 1) / fn->size) + sep_lo;
  src/Typeset/Boxes/Modifier/modifier_boxes.cpp:SI syx= big_fn->yx * script (big_fn->size, 1) / big_fn->size;
  ï¼ˆå…±æ‰¾åˆ°8å¤„ä½¿ç”¨ï¼‰

  3. ä»£ç åº“ç»“æ„ç†è§£

  - å­—ä½“ç³»ç»Ÿæ ¸å¿ƒç›®å½•ï¼šsrc/Graphics/Fonts/
  - æ’ä»¶ç›®å½•ï¼šsrc/Plugins/Freetype/ã€src/Plugins/Qt/ã€src/Plugins/Metafont/
  - æ’ç‰ˆç³»ç»Ÿç›®å½•ï¼šsrc/Typeset/
  - Scheme UI æ–‡ä»¶ï¼šTeXmacs/progs/fonts/font-new-widgets.scm

# ç¬¬äºŒé˜¶æ®µå®Œæˆæƒ…å†µï¼šæ ¸å¿ƒæ•°æ®ç»“æ„ä¿®æ”¹

  å·²å®Œæˆçš„ä¿®æ”¹ï¼š

  1. ä¿®æ”¹äº† font_rep ç»“æ„ä½“ï¼ˆåŒå­—æ®µå…¼å®¹è®¾è®¡ï¼‰

  - æ–‡ä»¶: src/Graphics/Fonts/font.hpp:57
  - ä¿®æ”¹å‰: SI size; // requested size
  - ä¿®æ”¹å: é‡‡ç”¨åŒå­—æ®µè®¾è®¡ï¼š
  SI     size_int;     // æ•´æ•°å­—ä½“å°ºå¯¸ï¼ˆå‘åå…¼å®¹ï¼‰
  SI     design_size;  // design size in points/256
  SI     display_size; // display size in points/PIXEL
  double size_float;   // æµ®ç‚¹å­—ä½“å°ºå¯¸ï¼ˆæ–°åŠŸèƒ½ï¼Œé»˜è®¤0.0è¡¨ç¤ºæœªä½¿ç”¨ï¼‰

  2. æ·»åŠ äº† effective_size() æˆå‘˜å‡½æ•°

  - åŠŸèƒ½: è·å–æœ‰æ•ˆå­—ä½“å°ºå¯¸ï¼Œä¼˜å…ˆä½¿ç”¨æµ®ç‚¹å°ºå¯¸ï¼ŒåŒ…å«0.5å€æ•°éªŒè¯
  - ä½ç½®: font_rep ç»“æ„ä½“å†…
  - é€»è¾‘:
    - å¦‚æœ size_float > 0.0ï¼ŒéªŒè¯æ˜¯å¦ä¸º0.5å€æ•°ï¼Œå¦‚æœä¸æ˜¯åˆ™è‡ªåŠ¨ä¿®æ­£
    - å¦åˆ™è¿”å› (double)size_int

  3. æ·»åŠ äº†è¾…åŠ©å‡½æ•°å’Œå…¼å®¹æ€§å¤„ç†

  - æ–‡ä»¶: src/Graphics/Fonts/font.hppï¼ˆåœ¨ font_name_unpack å‡½æ•°åæ·»åŠ ï¼‰
  - æ·»åŠ çš„å‡½æ•°:
  inline bool is_half_multiple(double sz);          // éªŒè¯æ˜¯å¦ä¸º0.5å€æ•°
  inline double round_to_half_multiple(double sz);  // å››èˆäº”å…¥åˆ°æœ€è¿‘çš„0.5å€æ•°
  inline double get_font_size(const font_rep* rep); // è·å–å®é™…å°ºå¯¸ï¼ˆä½¿ç”¨effective_sizeï¼‰
  inline void set_font_size(font_rep* rep, double size); // è®¾ç½®å°ºå¯¸ï¼ˆè‡ªåŠ¨éªŒè¯0.5å€æ•°ï¼‰
  inline int font_size_as_int(double sz);           // å…¼å®¹æ€§åŒ…è£…å‡½æ•°ï¼ˆå››èˆäº”å…¥ï¼‰

  - ç¼–è¯‘æŠ¥é”™ï¼ˆå·²ä¿®å¤ï¼‰ï¼šis_half_multiple() å’Œ round_to_half_multiple() å‡½æ•°å®šä¹‰ä½ç½®é—®é¢˜ï¼ˆç§»è‡³ font_rep ç»“æ„ä½“ä¹‹å‰ï¼‰

  4. ä¿®æ”¹äº†æ„é€ å‡½æ•°åˆå§‹åŒ–åˆ—è¡¨

  - æ–‡ä»¶: src/Graphics/Fonts/font.cpp
  - **ä¿®æ”¹äº† font_rep çš„ä¸¤ä¸ªæ„é€ å‡½æ•°ï¼Œæ›´æ–°å­—æ®µåˆå§‹åŒ–é¡ºåº

  5. æ·»åŠ äº†å¿…è¦çš„å¤´æ–‡ä»¶

  - åœ¨ font.hpp ä¸­æ·»åŠ äº† #include <cmath> ä»¥æ”¯æŒ fabs å’Œ round å‡½æ•°

# ç¬¬ä¸‰é˜¶æ®µå®Œæˆæƒ…å†µï¼šå‡½æ•°ç­¾åæ›´æ–°

å·²å®Œæˆçš„ä¿®æ”¹ï¼š

1. æ›´æ–°å­—ä½“åˆ›å»ºå‡½æ•°å£°æ˜

- æ–‡ä»¶: src/Graphics/Fonts/font.hppï¼ˆå¤šè¡Œéœ€è¦ä¿®æ”¹ï¼‰
- ä¿®æ”¹çš„å‡½æ•°ç­¾åï¼š
  - virtual_fontï¼šä» int sz æ”¹ä¸º double sz
  - find_fontï¼šä» int sz æ”¹ä¸º double sz
  - closest_fontï¼šä» int sz æ”¹ä¸º double sz
  - smart_fontï¼šä» int sz æ”¹ä¸º double sz
  - math_smart_fontï¼šä» int sz æ”¹ä¸º double sz
  - prog_smart_fontï¼šä» int sz æ”¹ä¸º double sz
  - x_fontã€qt_fontã€tex_fontã€tex_cm_fontã€tex_ec_fontã€tex_la_fontã€tex_gr_fontã€tex_adobe_fontã€tex_rubber_fontï¼šä» int sz æ”¹ä¸º double sz

2. æ›´æ–° smart_font_bis å‡½æ•°

- æ–‡ä»¶: src/Graphics/Fonts/smart_font.hpp:34-35
- ä¿®æ”¹å‰: font smart_font_bis (string f, string v, string s, string sh, int sz, int hdpi, int vdpi);
- ä¿®æ”¹å: font smart_font_bis (string f, string v, string s, string sh, double sz, int hdpi, int vdpi);

3. æ›´æ–° unicode_font å‡½æ•°

- æ–‡ä»¶: src/Graphics/Fonts/font.hpp:376-386
- ä¿®æ”¹å‰: font unicode_font (string family, int size, int dpi);
- ä¿®æ”¹å: font unicode_font (string family, double size, int dpi);

4. æ›´æ–° script() å‡½æ•°å£°æ˜

- æ–‡ä»¶: src/Graphics/Fonts/font.hpp:263
- ä¿®æ”¹å‰: int script (int sz, int level);
- ä¿®æ”¹å: double script (double sz, int level);

5. æ›´æ–° get_script_size() å‡½æ•°å£°æ˜

- æ–‡ä»¶: src/Typeset/env.hpp:521
- ä¿®æ”¹å‰: int get_script_size (int sz, int level);
- ä¿®æ”¹å: double get_script_size (double sz, int level);

# ç¬¬å››é˜¶æ®µå®Œæˆæƒ…å†µï¼šå®ç°æ–‡ä»¶ä¿®æ”¹

å·²å®Œæˆçš„ä¿®æ”¹ï¼š

1. ä¿®æ”¹ smart_font.cpp ä¸­çš„å®ç°

- æ–‡ä»¶: src/Graphics/Fonts/smart_font.cpp:1725-1781
- smart_font_bis() å‡½æ•°ï¼š
  - å‚æ•°ä» int sz æ”¹ä¸º double sz
  - æ·»åŠ 0.5å€æ•°éªŒè¯å’Œè‡ªåŠ¨ä¿®æ­£é€»è¾‘
  - æµ®ç‚¹å°ºå¯¸å­—ç¬¦ä¸²å¤„ç†ï¼šæ•´æ•°å¦‚"10"ï¼Œ0.5å€æ•°å¦‚"10.5"
  - ç¼“å­˜é”®ç”Ÿæˆæ­£ç¡®å¤„ç†æµ®ç‚¹æ•°

- smart_font() å‡½æ•°ï¼š
  - å‚æ•°ä» int sz æ”¹ä¸º double sz
  - æ·»åŠ 0.5å€æ•°éªŒè¯å’Œè‡ªåŠ¨ä¿®æ­£é€»è¾‘

2. ä¿®æ”¹ virtual_font.cpp

- æ–‡ä»¶: src/Graphics/Fonts/virtual_font.cpp:44-45, 2056-2065
- virtual_font_rep æ„é€ å‡½æ•°ï¼š
  - å‚æ•°ä» int size æ”¹ä¸º double size
- virtual_font() å‡½æ•°ï¼š
  - å‚æ•°ä» int size æ”¹ä¸º double size
  - æ·»åŠ 0.5å€æ•°éªŒè¯å’Œè‡ªåŠ¨ä¿®æ­£é€»è¾‘
  - æµ®ç‚¹å°ºå¯¸å­—ç¬¦ä¸²å¤„ç†

# ç¬¬äº”é˜¶æ®µå®Œæˆæƒ…å†µï¼šè®¡ç®—å‡½æ•°é€‚é…

å·²å®Œæˆçš„ä¿®æ”¹ï¼š

1. ä¿®æ”¹ script() å‡½æ•°ï¼ˆå…³é”®è®¡ç®—å‡½æ•°ï¼‰

- æ–‡ä»¶: src/Graphics/Fonts/font.cpp:577-592ï¼ˆç”¨æˆ·å·²ä¿®æ”¹ï¼‰
- ä¿®æ”¹å‰: int script (int sz, int level) { ... } // æ•´æ•°é™¤æ³•ï¼Œç²¾åº¦ä¸¢å¤±
- ä¿®æ”¹å: double script (double sz, int level) { ... } // æµ®ç‚¹è®¡ç®—ï¼Œä¿æŒç²¾åº¦
- æ·»åŠ 0.5å€æ•°è¾“å…¥éªŒè¯
- æµ®ç‚¹é™¤æ³•ä¿æŒç²¾åº¦ï¼Œè¾“å‡ºå¯èƒ½ä¸æ˜¯0.5å€æ•°ï¼ˆè®¾è®¡å…è®¸ï¼‰

2. ä¿®æ”¹ env_semantics.cpp ä¸­çš„ get_script_size() å®ç°å’Œå­—ä½“ç¼“å­˜ç³»ç»Ÿ

- æ–‡ä»¶: src/Typeset/Env/env_semantics.cpp
- å‡½æ•°ç­¾åå·²æ”¹ä¸º `double get_script_size(double sz, int level)`
- å…³é”®ä¿®æ”¹ï¼š
  1. æ·»åŠ 0.5å€æ•°éªŒè¯ï¼šä½¿ç”¨ `is_half_multiple()` å’Œ `round_to_half_multiple()` ç¡®ä¿è¾“å…¥ä¸º0.5å€æ•°
  2. ä¿®æ”¹ç´¢å¼•è®¡ç®—ï¼šä» `(int)(sz + 0.5)` æ”¹ä¸º `(int)(sz * 2.0)`ï¼Œæ­£ç¡®æ”¯æŒ0.5å€æ•°ç´¢å¼•
  3. æ›´æ–°ç¼“å­˜è®¿é—®ï¼š`array<int>& a (size_cache[isz])` æ”¹ä¸º `array<double>& a (size_cache[isz])`
  4. æ·»åŠ å¤´æ–‡ä»¶åŒ…å«ï¼š`#include "Graphics/Fonts/font.hpp"` ä»¥ä½¿ç”¨æµ®ç‚¹è¾…åŠ©å‡½æ•°

3. ä¿®æ”¹ determine_sizes() å‡½æ•°ä»¥æ”¯æŒæµ®ç‚¹å­—ä½“å°ºå¯¸

- æ–‡ä»¶: src/Typeset/Env/env_semantics.cpp:491
- å‡½æ•°ç­¾åä¿®æ”¹ï¼šä» `determine_sizes (tree szt, int sz)` æ”¹ä¸º `determine_sizes (tree szt, double sz)`
- è¿”å›ç±»å‹ä¿®æ”¹ï¼šä» `array<int>` æ”¹ä¸º `array<double>`
- å†…éƒ¨ä¿®æ”¹ï¼š
  1. `r << as_int (s)` æ”¹ä¸º `r << (double) as_int (s)`
  2. `int xsz= (int) ceil ((x - 0.001) * sz)` æ”¹ä¸º `double xsz= ceil ((x - 0.001) * sz)`
  3. `r << script (sz, 1)` å’Œ `r << script (sz, 2)` ä¿æŒä¸å˜ï¼ˆscript() å·²è¿”å› doubleï¼‰
  4. æ›´æ–°è°ƒç”¨å¤„ï¼š`size_cache << determine_sizes (math_font_sizes, xsz)` ä¸­çš„ xsz ä» int æ”¹ä¸º double

# ç¬¬å…­é˜¶æ®µå®Œæˆæƒ…å†µï¼šç¯å¢ƒå¤„ç†ä¿®æ”¹

å·²å®Œæˆçš„ä¿®æ”¹ï¼š

1. ä¿®æ”¹å­—ä½“å¤§å°è®¡ç®—é€»è¾‘

- æ–‡ä»¶: src/Typeset/Env/env_semantics.cpp:540-541
- ä¿®æ”¹å‰: fn_size= (int) (((double) get_int (FONT_BASE_SIZE)) * get_double (FONT_SIZE) + 0.5);
- ä¿®æ”¹å:
  double base_size = get_double (FONT_BASE_SIZE);
  fn_size = base_size * get_double (FONT_SIZE);
- fn_size ç±»å‹å·²æ”¹ä¸º doubleï¼ˆåœ¨ env.hpp ä¸­å®šä¹‰ï¼‰

2. æ›´æ–° env.hpp ä¸­çš„ fn_size ç±»å‹

- æ–‡ä»¶: src/Typeset/env.hpp:178
- ä¿®æ”¹å‰: int fn_size;
- ä¿®æ”¹å: double fn_size;

3. æ›´æ–° env.hpp ä¸­çš„ size_cache ç±»å‹ä»¥æ”¯æŒæµ®ç‚¹å­—ä½“å°ºå¯¸

- æ–‡ä»¶: src/Typeset/env.hpp:161
- ä¿®æ”¹å‰: `array<array<int>> size_cache;  // math font size cache`
- ä¿®æ”¹å: `array<array<double>> size_cache;  // math font size cache`
- åŸå› ï¼šå­—ä½“ç¼“å­˜ç³»ç»Ÿéœ€è¦æ”¯æŒ0.5å€æ•°å­—ä½“å°ºå¯¸ï¼Œå› æ­¤éœ€è¦å°†æ•´æ•°ç¼“å­˜æ”¹ä¸ºæµ®ç‚¹ç¼“å­˜

4. æ›´æ–° env_semantics.cpp ä¸­çš„ size_cache åˆå§‹åŒ–ä»£ç 

- æ–‡ä»¶: src/Typeset/Env/env_semantics.cpp:919 å’Œ 1007
- ä¿®æ”¹å‰: `size_cache = array<array<int>> ();`
- ä¿®æ”¹å: `size_cache = array<array<double>> ();`
- å½±å“ï¼šä¸¤å¤„åˆå§‹åŒ–ä»£ç éƒ½éœ€è¦æ›´æ–°ç±»å‹ä»¥åŒ¹é…æ–°çš„æµ®ç‚¹ç¼“å­˜ç±»å‹

5. æ›´æ–°å…¶ä»–ä½¿ç”¨ get_int(FONT_BASE_SIZE) çš„åœ°æ–¹

- æ–‡ä»¶: src/Typeset/Env/env_length.cppï¼ˆå¤šå¤„ä¿®æ”¹ï¼‰
- ä¿®æ”¹çš„å‡½æ•°ï¼š
  - exec_fs_length(): get_int â†’ get_double
  - exec_fbs_length(): get_int â†’ get_double
  - exec_fn_length(): get_int â†’ get_double
  - exec_fns_length(): get_int â†’ get_double
  - exec_bls_length(): get_int â†’ get_double
- æ‰€æœ‰ç›¸å…³è®¡ç®—ç°åœ¨ä½¿ç”¨æµ®ç‚¹ç²¾åº¦

# ç¬¬ä¸ƒé˜¶æ®µå®Œæˆæƒ…å†µï¼šå¸ƒå±€è®¡ç®—é€‚é…

å·²å®Œæˆçš„ä¿®æ”¹ï¼š

1. ä¿®æ”¹ script_boxes.cpp ä¸­çš„è®¡ç®—

- æ–‡ä»¶: src/Typeset/Boxes/Composite/script_boxes.cppï¼ˆ4å¤„ä¿®æ”¹ï¼‰
- ä¿®æ”¹çš„è¡¨è¾¾å¼ï¼š
  - line 94: SI top = max (lo->y2, fn->y2 * script (fn->size, 1) / fn->size) + sep_lo;
    â†’ SI top = max (lo->y2, (SI)(fn->y2 * script (fn->effective_size (), 1) / fn->effective_size () + 0.5)) + sep_lo;
  - line 106: SI bot = min (hi->y1, fn->y1 * script (fn->size, 1) / fn->size) - sep_hi;
    â†’ SI bot = min (hi->y1, (SI)(fn->y1 * script (fn->effective_size (), 1) / fn->effective_size () + 0.5)) - sep_hi;
  - line 210: SI miny2 = (fn->y2 - fn->yshift) * script (fn->size, 1) / fn->size;
    â†’ SI miny2 = (SI)((fn->y2 - fn->yshift) * script (fn->effective_size (), 1) / fn->effective_size () + 0.5);
  - line 374: SI miny2 = (fn->y2 - fn->yshift) * script (fn->size, 1) / fn->size;
    â†’ SI miny2 = (SI)((fn->y2 - fn->yshift) * script (fn->effective_size (), 1) / fn->effective_size () + 0.5);

2. ä¿®æ”¹ modifier_boxes.cpp

- æ–‡ä»¶: src/Typeset/Boxes/Modifier/modifier_boxes.cpp:449
- ä¿®æ”¹å‰: SI syx = big_fn->yx * script (big_fn->size, 1) / big_fn->size;
- ä¿®æ”¹å: SI syx = (SI)(big_fn->yx * script (big_fn->effective_size (), 1) / big_fn->effective_size () + 0.5);

3. æ›´æ–°ç›¸å…³æ–‡ä»¶ä¸­çš„ç±»å‹

- æ–‡ä»¶: src/Typeset/Concat/concater.cppï¼ˆ3å¤„ï¼‰
  - line 49: int sz â†’ double sz
  - line 96: int sz â†’ double sz
  - line 129: int sz â†’ double sz
- æ–‡ä»¶: src/Typeset/Concat/concat_animate.cpp:231
  - line 231: int sz â†’ double sz

4. ä¿®æ”¹ smart_font.cpp ä¸­çš„å­—ä½“æ•ˆæœè®¡ç®—

- æ–‡ä»¶: src/Graphics/Fonts/smart_font.cppï¼ˆ2å¤„ä¿®æ”¹ï¼‰
  - line 1962: if (rad_unit == "pt") rad_val= rad_val / fn->size;
    â†’ if (rad_unit == "pt") rad_val= rad_val / fn->effective_size ();
  - line 1974: if (rad_unit == "pt") rad_val= rad_val / fn->size;
    â†’ if (rad_unit == "pt") rad_val= rad_val / fn->effective_size ();
- ä¿®æ”¹åŸå› ï¼šå­—ä½“æ•ˆæœï¼ˆæ¨¡ç³Šã€å¢å¼ºï¼‰è®¡ç®—éœ€è¦åŸºäºå®é™…å­—ä½“å°ºå¯¸

# ç¬¬å…«é˜¶æ®µå®Œæˆæƒ…å†µï¼šæ’ä»¶é€‚é…

å·²å®Œæˆçš„ä¿®æ”¹ï¼š

1. ä¿®æ”¹ Qt æ’ä»¶

- æ–‡ä»¶: src/Plugins/Qt/qt_gui.cpp:1035
  - load_system_font() å‚æ•°ä» int sz æ”¹ä¸º double sz
- æ–‡ä»¶: src/Plugins/Qt/qt_font.hpp
  - qt_font_rep æ„é€ å‡½æ•°ä» int size æ”¹ä¸º double size
  - size å­—æ®µä» int æ”¹ä¸º double
- æ–‡ä»¶: src/Plugins/Qt/qt_font.cpp:29-43
  - qt_font_rep æ„é€ å‡½æ•°æ·»åŠ 0.5å€æ•°éªŒè¯
  - ä¿®æ­£ design_size è®¡ç®—ï¼šä» size << 8 æ”¹ä¸º (SI)(size * 256.0)
  - å¦‚æœå°ºå¯¸è¢«ä¿®æ­£ï¼Œé‡æ–°åˆå§‹åŒ– QFont å’Œ QFontMetricsF

2. ä¿®æ”¹ Freetype æ’ä»¶

- æ–‡ä»¶: src/Plugins/Freetype/unicode_font.hpp:44
  - unicode_font_rep æ„é€ å‡½æ•°ä» int size æ”¹ä¸º double size
- æ–‡ä»¶: src/Plugins/Freetype/unicode_font.cpp
  - unicode_font() å‡½æ•°ï¼ˆä¸¤ä¸ªé‡è½½ï¼‰ä» int size æ”¹ä¸º double size
  - æ·»åŠ 0.5å€æ•°éªŒè¯å’Œæµ®ç‚¹å°ºå¯¸å­—ç¬¦ä¸²å¤„ç†
  - unicode_font_rep æ„é€ å‡½æ•°æ·»åŠ 0.5å€æ•°éªŒè¯
  - æ³¨æ„ï¼šsize å­—æ®µå¯èƒ½ä»æ˜¯ intï¼Œä½† font_rep æœ‰ size_int å’Œ size_float å­—æ®µ

3. ä¿®æ”¹ font.hpp ä¸­çš„ tt_font() å‡½æ•°

- æ–‡ä»¶: src/Graphics/Fonts/font.hpp:427-432
- å‚æ•°ä» int size æ”¹ä¸º double size
- æ·»åŠ 0.5å€æ•°éªŒè¯å’Œæµ®ç‚¹å°ºå¯¸å­—ç¬¦ä¸²å¤„ç†

4. ä¿®æ”¹ Metafont æ’ä»¶ï¼ˆload_tex.cppï¼‰

- æ–‡ä»¶: src/Plugins/Metafont/load_tex.cpp
  - æ·»åŠ  `to_tex_font_size()` è¾…åŠ©å‡½æ•°ï¼šå°†ç‚¹å€¼å°ºå¯¸è½¬æ¢ä¸º TeX å­—ä½“å°ºå¯¸è¡¨ç¤ºï¼ˆæ•´æ•°å°ºå¯¸ä¿æŒåŸæ ·ï¼Œ0.5å€æ•°ä¹˜ä»¥100ï¼Œå¦‚10.5â†’1050ï¼‰
  - æ›´æ–°å‡½æ•°ç­¾åï¼š
    - `try_tfm()`ï¼šä» `int size, int osize` æ”¹ä¸º `double size, double osize`
    - `load_tex_tfm()`ï¼šä» `int size, int dsize` æ”¹ä¸º `double size, int dsize`ï¼ˆä¿æŒæ¥å£å…¼å®¹æ€§ï¼‰
    - `try_pk()` å’Œ `load_tex_pk()`ï¼šä» `int size` æ”¹ä¸º `double size`
  - å†…éƒ¨å¤„ç†ï¼š
    - ä½¿ç”¨ `to_tex_font_size()` è½¬æ¢å°ºå¯¸ç”¨äºæ–‡ä»¶åç”Ÿæˆ
    - æµ®ç‚¹æ¯”è¾ƒï¼šä½¿ç”¨ `fabs(size - 10.0) > 0.1` ä»£æ›¿ `size != 10`
    - æ›´æ–° `mag()` å‡½æ•°è°ƒç”¨ä¸­çš„ç±»å‹è½¬æ¢
    - ä¿®å¤ `load_tex_pk()` ä¸­çš„é€’å½’è°ƒç”¨ï¼š`(size + 50) / 100` æ”¹ä¸º `(size + 50.0) / 100.0`
  - æ›´æ–° Windows å›é€€é€»è¾‘ï¼š`load_tex_tfm("ecrm", 10, ...)` æ”¹ä¸º `load_tex_tfm("ecrm", 10.0, ...)`

# ç¬¬ä¹é˜¶æ®µå®Œæˆæƒ…å†µï¼šç”¨æˆ·ç•Œé¢é€‚é…

å·²å®Œæˆçš„ä¿®æ”¹ï¼š

1. æ‰©å±•å­—ä½“å¤§å°é¢„è®¾åˆ—è¡¨

- æ–‡ä»¶: TeXmacs/progs/fonts/font-new-widgets.scm:476-483
- ä¿®æ”¹ font-default-sizes åˆ—è¡¨ï¼š
  - æ·»åŠ  8.5ã€9.5ã€10.5ã€11.5ã€12.5ã€13ã€15 ç­‰0.5å€æ•°å°ºå¯¸
  - ä¿æŒå‘åå…¼å®¹æ€§ï¼Œä¿ç•™åŸæœ‰æ•´æ•°å°ºå¯¸
- ä¿®æ”¹ font-default-sizes* åˆ—è¡¨ï¼š
  - æ·»åŠ  8.5ã€9.5ã€10.5ã€11.5 ç­‰å¸¸ç”¨0.5å€æ•°å°ºå¯¸

# ç¬¬åé˜¶æ®µå®Œæˆæƒ…å†µï¼šæµ‹è¯•éªŒè¯

## å•å…ƒæµ‹è¯•å®Œæˆæƒ…å†µ

å·²åˆ›å»ºæµ‹è¯•æ–‡ä»¶ `tests/Graphics/Fonts/font_size_test.cpp`ï¼Œè¦†ç›–ä»¥ä¸‹æµ‹è¯•é¡¹ç›®ï¼š

### 1. 0.5å€æ•°éªŒè¯å‡½æ•°æµ‹è¯•
- `test_is_half_multiple()`: æµ‹è¯• `is_half_multiple()` å‡½æ•°
- `test_round_to_half_multiple()`: æµ‹è¯• `round_to_half_multiple()` å‡½æ•°
- `test_normalize_half_multiple_size()`: æµ‹è¯• `normalize_half_multiple_size()` è¾…åŠ©å‡½æ•°
- éªŒè¯æ•´æ•°å°ºå¯¸ã€0.5å€æ•°å°ºå¯¸ã€é0.5å€æ•°å°ºå¯¸çš„æ­£ç¡®åˆ¤æ–­
- æµ‹è¯•è¾¹ç•Œæƒ…å†µå’Œå››èˆäº”å…¥é€»è¾‘
- éªŒè¯å®¹å·®å¤„ç†é€»è¾‘ï¼ˆ0.001å®¹å·®å†…ä¿æŒåŸå€¼ï¼Œå¦åˆ™å››èˆäº”å…¥ï¼‰

### 2. æµ®ç‚¹å­—ä½“åˆ›å»ºæµ‹è¯•
- `test_smart_font_float_size()`: æµ‹è¯• `smart_font()` å‡½æ•°æ”¯æŒæµ®ç‚¹å°ºå¯¸
  - æµ‹è¯•æ•´æ•°å°ºå¯¸ã€0.5å€æ•°å°ºå¯¸ã€é0.5å€æ•°å°ºå¯¸ï¼ˆè‡ªåŠ¨ä¿®æ­£ï¼‰
  - éªŒè¯å‘åå…¼å®¹æ€§ï¼šæ•´æ•°å’Œæµ®ç‚¹æ•´æ•°ï¼ˆå¦‚10å’Œ10.0ï¼‰äº§ç”Ÿç›¸åŒç»“æœ
- `test_virtual_font_float_size()`: æµ‹è¯• `virtual_font()` å‡½æ•°æ”¯æŒæµ®ç‚¹å°ºå¯¸
  - ä½¿ç”¨ç°æœ‰è™šæ‹Ÿå­—ä½“æ–‡ä»¶ `emu-arrows.vfn`
  - æµ‹è¯•æ•´æ•°å°ºå¯¸ã€0.5å€æ•°å°ºå¯¸ã€é0.5å€æ•°è‡ªåŠ¨ä¿®æ­£
  - éªŒè¯æ•´æ•°å’Œæµ®ç‚¹æ•´æ•°äº§ç”Ÿç›¸åŒç»“æœ

### 3. script()å‡½æ•°æµ‹è¯•
- `test_script_function()`: æµ‹è¯• `script()` å‡½æ•°è®¡ç®—ç»“æœ
- éªŒè¯level 0ã€1ã€2çš„è®¡ç®—æ­£ç¡®æ€§
- æµ‹è¯•é0.5å€æ•°è¾“å…¥è‡ªåŠ¨ä¿®æ­£
- æµ‹è¯•è¾¹ç•Œæ¡ä»¶ï¼ˆè´Ÿçº§åˆ«ã€å¤§äº2çš„çº§åˆ«ï¼‰

### 4. ç¼“å­˜é”®ç”Ÿæˆæµ‹è¯•
- `test_cache_key_generation()`: æµ‹è¯•å­—ä½“ç¼“å­˜é”®ç”Ÿæˆ
- éªŒè¯æ•´æ•°å°ºå¯¸å’Œæµ®ç‚¹æ•´æ•°å°ºå¯¸ç”Ÿæˆç›¸åŒç¼“å­˜é”®
- éªŒè¯0.5å€æ•°å°ºå¯¸ç”Ÿæˆä¸åŒçš„ç¼“å­˜é”®
- æµ‹è¯•é0.5å€æ•°å°ºå¯¸è‡ªåŠ¨ä¿®æ­£åçš„ç¼“å­˜é”®

### 5. è¾…åŠ©å‡½æ•°æµ‹è¯•
- `test_font_size_as_int()`: æµ‹è¯• `font_size_as_int()` å…¼å®¹æ€§åŒ…è£…å‡½æ•°
- `test_effective_size()`: æµ‹è¯• `effective_size()` æ–¹æ³•
- `test_set_get_font_size()`: æµ‹è¯• `set_font_size()` å’Œ `get_font_size()` å‡½æ•°
- éªŒè¯åŒå­—æ®µæ¶æ„ï¼ˆsize_int + size_floatï¼‰çš„æ­£ç¡®å·¥ä½œ

### 6. TeXå­—ä½“å°ºå¯¸è½¬æ¢æµ‹è¯•
- `test_to_tex_font_size()`: æµ‹è¯• `to_tex_font_size()` å‡½æ•°
  - å‡½æ•°ä» `static` æ”¹ä¸ºå…¨å±€å¯è§ï¼Œåœ¨ `load_tex.hpp` ä¸­å£°æ˜
  - ä¿®å¤æ¡ä»¶åˆ¤æ–­é¡ºåºï¼šå…ˆæ£€æŸ¥æ•´æ•°ï¼Œå†æ£€æŸ¥0.5å€æ•°
  - éªŒè¯æ•´æ•°å°ºå¯¸ä¿æŒä¸å˜ï¼ˆå¦‚10.0 â†’ 10.0ï¼‰
  - éªŒè¯0.5å€æ•°å°ºå¯¸ä¹˜ä»¥100ï¼ˆå¦‚10.5 â†’ 1050.0ï¼‰
  - éªŒè¯å·²ä¹˜ä»¥100çš„å€¼æ­£ç¡®å¤„ç†ï¼ˆå¦‚1000.0 â†’ 10.0ï¼Œ1050.0 â†’ 1050.0ï¼‰
  - æµ‹è¯•é0.5å€æ•°å››èˆäº”å…¥åˆ°æœ€è¿‘æ•´æ•°
  - æµ‹è¯•è¾¹ç•Œæƒ…å†µï¼ˆ0.0ã€0.5ã€1.0ï¼‰

### 7. å‘åå…¼å®¹æ€§æµ‹è¯•
- `test_backward_compatibility()`: æµ‹è¯•å‘åå…¼å®¹æ€§
- éªŒè¯æ•´æ•°å­—ä½“å°ºå¯¸ç»§ç»­æ­£å¸¸å·¥ä½œ
- æµ‹è¯•æ–°æ—§è¡Œä¸ºçš„ä¸€è‡´æ€§

### 8. get_script_size()å‡½æ•°æµ‹è¯•
- `test_get_script_size()`: æµ‹è¯• `get_script_size()` å‡½æ•°
- éªŒè¯ `script()` å‡½æ•°åœ¨å„çº§åˆ«ä¸‹çš„è®¡ç®—ç»“æœæ­£ç¡®æ€§
- æµ‹è¯•é0.5å€æ•°è¾“å…¥è‡ªåŠ¨ä¿®æ­£
- æµ‹è¯•çº§åˆ«è¾¹ç•Œå¤„ç†ï¼ˆè´Ÿçº§åˆ«ã€å¤§äº2çš„çº§åˆ«ï¼‰

### 9. determine_sizes()å‡½æ•°æµ‹è¯•
- `test_determine_sizes()`: æµ‹è¯• `determine_sizes()` å‡½æ•°
- éªŒè¯æ•´æ•°è½¬æ¢é€»è¾‘ï¼ˆ`as_int` å¤„ç†ï¼‰
- æµ‹è¯•ä¹˜æ³•è¯­æ³•å¤„ç†ï¼ˆå¦‚ `*1.2`ã€`*0.8`ï¼‰
- æµ‹è¯•é™¤æ³•è¯­æ³•å¤„ç†ï¼ˆå¦‚ `*3/2`ï¼‰
- éªŒè¯è„šæœ¬å‡½æ•°å›é€€é€»è¾‘ï¼ˆæœªæ‰¾åˆ°åŒ¹é…å…ƒç»„æ—¶ä½¿ç”¨ `script()` å‡½æ•°ï¼‰
- æµ‹è¯•0.5å€æ•°å­—ä½“å°ºå¯¸æ”¯æŒ

### 10. æ€§èƒ½æµ‹è¯•
- `test_performance_script_function()`: æµ‹è¯• `script()` å‡½æ•°æ€§èƒ½
- `test_performance_to_tex_font_size()`: æµ‹è¯• `to_tex_font_size()` å‡½æ•°æ€§èƒ½
- `test_performance_float_calculations()`: æµ‹è¯•æµ®ç‚¹è®¡ç®—æ€§èƒ½
- éªŒè¯0.5å€æ•°éªŒè¯å’Œå››èˆäº”å…¥æ“ä½œçš„æ€§èƒ½è¡¨ç°
- ç¡®ä¿æ€§èƒ½å¼€é”€åœ¨å¯æ¥å—èŒƒå›´å†…

## æµ‹è¯•æ‰§è¡Œç»“æœ

æ‰€æœ‰æµ‹è¯•å·²é€šè¿‡éªŒè¯ï¼š
```
********* Start testing of TestFontSize *********
PASS   : TestFontSize::initTestCase()
PASS   : TestFontSize::test_is_half_multiple()
PASS   : TestFontSize::test_round_to_half_multiple()
PASS   : TestFontSize::test_normalize_half_multiple_size()
PASS   : TestFontSize::test_font_size_as_int()
PASS   : TestFontSize::test_effective_size()
PASS   : TestFontSize::test_set_get_font_size()
PASS   : TestFontSize::test_script_function()
PASS   : TestFontSize::test_smart_font_float_size()
PASS   : TestFontSize::test_backward_compatibility()
PASS   : TestFontSize::test_virtual_font_float_size()
PASS   : TestFontSize::test_cache_key_generation()
PASS   : TestFontSize::test_to_tex_font_size()
PASS   : TestFontSize::test_get_script_size()
PASS   : TestFontSize::test_determine_sizes()
PASS   : TestFontSize::test_performance_script_function()
PASS   : TestFontSize::test_performance_to_tex_font_size()
PASS   : TestFontSize::test_performance_float_calculations()
PASS   : TestFontSize::cleanupTestCase()
Totals: 19 passed, 0 failed, 0 skipped, 0 blacklisted, 1260ms
********* Finished testing of TestFontSize *********
```

## è§†è§‰å›å½’æµ‹è¯•
  - åœ¨ `TeXmacs/tests/tmu/206_18.tmu`ä¸­å®ç°

# ç¬¬åä¸€é˜¶æ®µå®Œæˆæƒ…å†µï¼šç¼–è¯‘é”™è¯¯ä¿®å¤æ•´åˆ

## æ€»ä½“çŠ¶æ€
æ‰€æœ‰ç¼–è¯‘ã€é“¾æ¥å’Œè¿è¡Œæ—¶é”™è¯¯å·²ä¿®å¤ï¼Œä»£ç å¯æˆåŠŸç¼–è¯‘å¹¶è¿è¡Œå•å…ƒæµ‹è¯•ã€‚

## å·²ä¿®å¤çš„é”™è¯¯åˆ†ç±»

### 1. æ ¸å¿ƒç»“æ„è®¿é—®é”™è¯¯
**æ ¹æœ¬åŸå› **: `font_rep`ç»“æ„ä½“å·²æ”¹ä¸ºåŒå­—æ®µè®¾è®¡ï¼ˆ`size_int` + `size_float`ï¼‰ï¼ŒåŸ`size`æˆå‘˜ä¸å†å­˜åœ¨ï¼Œéœ€è¦æ”¹ç”¨`effective_size()`æˆå‘˜å‡½æ•°æˆ–`set_font_size()`è¾…åŠ©å‡½æ•°ã€‚

- **virtual_enhance.cpp**: `base->size` â†’ `base->effective_size()`
- **smart_font.cpp**: æ„é€ å‡½æ•°å‚æ•°ä» `int sz2` æ”¹ä¸º `double sz2`
- **unicode_font.cpp**: ä½¿ç”¨ `set_font_size()` è¾…åŠ©å‡½æ•°ï¼Œæ›´æ–°è®¾è®¡å°ºå¯¸è®¡ç®—
- **å…¶ä»–æ–‡ä»¶ä¸­çš„ `->size` ä½¿ç”¨**: æ‰€æœ‰ `base->size` æ”¹ä¸º `base->effective_size()`
  - `poor_rubber.cpp`ã€`rubber_unicode_font.cpp`ã€`rubber_stix_font.cpp`ã€`rubber_assemble_font.cpp`
- **tex_rubber_font.cpp**: æ„é€ å‡½æ•°å‚æ•°æ›´æ–°ï¼Œä½¿ç”¨ `set_font_size()`
- **tex_font.cpp**: å‡½æ•°ç­¾åæ›´æ–°ï¼Œä½¿ç”¨ `effective_size()` è·å–å®é™…å­—ä½“å°ºå¯¸

### 2. å­—ä½“ç¼“å­˜ç³»ç»Ÿç±»å‹é”™è¯¯
**æ–‡ä»¶**: `src/Typeset/Env/env_semantics.cpp`
**é—®é¢˜**:
- `determine_sizes()`å‡½æ•°ä¸æ”¯æŒæµ®ç‚¹å­—ä½“å°ºå¯¸
- `get_script_size()`å‡½æ•°é”™è¯¯å¤„ç†0.5å€æ•°
- `size_cache`ç±»å‹ä¸åŒ¹é…

**ä¿®å¤**:
- `determine_sizes()`å‡½æ•°ç­¾å: `int sz` â†’ `double sz`ï¼Œè¿”å›ç±»å‹ `array<int>` â†’ `array<double>`
- `get_script_size()`: æ·»åŠ 0.5å€æ•°éªŒè¯ï¼Œä¿®æ”¹ç´¢å¼•è®¡ç®—
- `size_cache`ç±»å‹: `array<array<int>>` â†’ `array<array<double>>`

### 3. FreeTypeæ’ä»¶ç›¸å…³é”™è¯¯
- **tt_font.cpp**: æ„é€ å‡½æ•°å’Œå‡½æ•°å‚æ•°æ›´æ–°ä¸º `double`ï¼Œæ·»åŠ 0.5å€æ•°éªŒè¯
- **tt_face.cpp å’Œ tt_file.hpp**: å‡½æ•°å£°æ˜å’Œç»“æ„ä½“æˆå‘˜ç±»å‹æ›´æ–°ä¸º `double`
- **FONT_TYPE_TTå¸¸é‡**: åœ¨ `font.hpp` ä¸­æ·»åŠ å¸¸é‡å®šä¹‰
- **ç±»å‹è½¬æ¢é”™è¯¯**: `size << 6` â†’ `(FT_F26Dot6)(size * 64.0 + 0.5)`

### 4. é“¾æ¥é”™è¯¯
**é—®é¢˜**: å‡½æ•°å£°æ˜å·²æ›´æ–°ä¸º `double size`ï¼Œä½†å®ç°æ–‡ä»¶ä¸­çš„å‡½æ•°å®šä¹‰æœªæ›´æ–°
**å½±å“å‡½æ•°**:
- `find_font()`ã€`closest_font()`ã€`x_font()`ã€`qt_font()`
**ä¿®å¤**: æ›´æ–°ç›¸å…³å®ç°æ–‡ä»¶çš„å‡½æ•°ç­¾åï¼Œæ·»åŠ æµ®ç‚¹å°ºå¯¸å­—ç¬¦ä¸²å¤„ç†

### 5. é€»è¾‘é”™è¯¯å’Œè¿è¡Œæ—¶é—®é¢˜
**æ–‡ä»¶**: `src/Plugins/Metafont/load_tex.cpp`
**é—®é¢˜**: `to_tex_font_size()`å‡½æ•°é€»è¾‘é”™è¯¯å¯¼è‡´å­—ä½“å°ºå¯¸è½¬æ¢ä¸æ­£ç¡®
**ä¿®å¤**: æ›´æ–°å‡½æ•°é€»è¾‘ï¼Œæ­£ç¡®å¤„ç†æ•´æ•°å’Œ0.5å€æ•°çš„åˆ¤æ–­ï¼Œé¿å…æ•´æ•°è¢«è¯¯åˆ¤ä¸º0.5å€æ•°

# ç¬¬åäºŒé˜¶æ®µå®Œæˆæƒ…å†µï¼šæ€§èƒ½ç›‘æ§åˆ†æ

## æ€§èƒ½ç›‘æ§å·²å¯ç”¨

æ€§èƒ½æ•°æ®å·²æ­£å¸¸æ‰“å°ï¼Œæ€§èƒ½ç›‘æ§åœ¨æ€§èƒ½æµ‹è¯•å‡½æ•°ä¸­å·²æ·»åŠ ï¼š

```cpp
debug_set ("bench", true);
lolly::system::bench_print (std_bench, "font_script_calculation", 0);
```

## æ€§èƒ½æ•°æ®åˆ†æç»“æœï¼ˆWindowså¹³å°æµ‹è¯•ï¼‰

### 1. æµ®ç‚¹è®¡ç®—æ€§èƒ½æä½³

| ä»»åŠ¡ | æ€»æ—¶é—´ | è°ƒç”¨æ¬¡æ•° | æ¯æ¬¡è°ƒç”¨æ—¶é—´ | æ€§èƒ½è¯„ä¼° |
|------|--------|----------|--------------|----------|
| `font_script_calculation` | 36ms | 180,100æ¬¡ | 0.0002ms (0.2Î¼s) | âœ… æä½³ |
| `to_tex_font_size_conversion` | 25ms | 130,000æ¬¡ | 0.00019ms (0.19Î¼s) | âœ… æä½³ |

**ç»“è®º**ï¼šå­—ä½“å¤§å°æµ®ç‚¹è®¡ç®—æ€§èƒ½éå¸¸ä¼˜ç§€ï¼Œæ— éœ€ä¼˜åŒ–ã€‚

### 2. å®é™…æ€§èƒ½ç“¶é¢ˆè¯†åˆ«

| ä»»åŠ¡ | æ€»æ—¶é—´ | è°ƒç”¨æ¬¡æ•° | æ¯æ¬¡è°ƒç”¨æ—¶é—´ | æ€§èƒ½è¯„ä¼° |
|------|--------|----------|--------------|----------|
| `tt_locate_all` | 98ms | - | - | ğŸ”´ é«˜ä¼˜å…ˆçº§ |
| `tt_font_exists NotoSerifCJK-Regular` | 108ms | - | - | ğŸ”´ é«˜ä¼˜å…ˆçº§ |
| `find font` | 23ms | 15æ¬¡ | 1.53ms | ğŸ”´ é«˜ä¼˜å…ˆçº§ |
| `load tex font` | 21ms | 6æ¬¡ | 3.5ms | ğŸ”´ é«˜ä¼˜å…ˆçº§ |
| `decode tfm` | 0ms | 6æ¬¡ | 0ms | ğŸŸ¢ è‰¯å¥½ |
| `load tt face` | 0ms | 6æ¬¡ | 0ms | ğŸŸ¢ è‰¯å¥½ |

# ç¬¬åä¸‰é˜¶æ®µå®Œæˆæƒ…å†µï¼šæ€§èƒ½ä¼˜åŒ–è¡¥å……

åŸºäºæ€§èƒ½ç›‘æ§åˆ†æç»“æœï¼Œå·²å®æ–½ä»¥ä¸‹ä¼˜åŒ–ï¼š

## 1. TrueTypeå­—ä½“å­˜åœ¨æ€§ç¼“å­˜ä¼˜åŒ– (`tt_file.cpp`)

### ä¼˜åŒ–å†…å®¹
- å°† `tt_fonts` ä» `hashset<string>` æ”¹ä¸º `hashmap<string, bool>`ï¼Œå­˜å‚¨å­—ä½“å­˜åœ¨çŠ¶æ€
- å½“å­—ä½“å·²çŸ¥ä¸å­˜åœ¨æ—¶å¿«é€Ÿè¿”å› `false`ï¼Œé¿å…é‡å¤æŸ¥æ‰¾

### ä»£ç å˜æ›´
```cpp
// ä¿®æ”¹å‰ï¼šä»…å­˜å‚¨å­˜åœ¨çš„å­—ä½“
static hashset<string> tt_fonts;

// ä¿®æ”¹åï¼šå­˜å‚¨å­˜åœ¨çŠ¶æ€ï¼ˆtrue=å­˜åœ¨ï¼Œfalse=ä¸å­˜åœ¨ï¼‰
static hashmap<string, bool> tt_fonts;
```

### ä¼˜åŒ–æ•ˆæœ
- å‡å°‘äº†é‡å¤çš„å­—ä½“å­˜åœ¨æ£€æŸ¥å¼€é”€
- å½“å­—ä½“ç¡®è®¤ä¸å­˜åœ¨æ—¶ï¼Œåç»­æŸ¥è¯¢ç›´æ¥è¿”å› `false`ï¼Œæ— éœ€é‡å¤æœç´¢

## 2. TFM/PKå†…å­˜ç¼“å­˜ (`load_tex.cpp`)

### ä¼˜åŒ–å†…å®¹
- æ·»åŠ  `tfm_cache` å’Œ `pk_cache` å†…å­˜ç¼“å­˜
- é¿å…é‡å¤ç£ç›˜åŠ è½½ TFM å’Œ PK æ–‡ä»¶
- ç¼“å­˜é”®æ ¼å¼ï¼š`family:size:dsize` (TFM) å’Œ `family:size:dpi:dsize` (PK)

### ä»£ç å®ç°
```cpp
// åœ¨ load_tex.cpp ä¸­æ·»åŠ å†…å­˜ç¼“å­˜
static hashmap<string, tex_font_metric> tfm_cache;
static hashmap<string, font_glyphs> pk_cache;

// åœ¨ load_tex_tfm() å’Œ load_tex_pk() å‡½æ•°ä¸­æ·»åŠ ç¼“å­˜æ£€æŸ¥
string cache_key = family * ":" * as_string(size) * ":" * as_string(dsize);
if (tfm_cache->contains(cache_key)) {
    tfm = tfm_cache[cache_key];
    return true;
}
// ... åŠ è½½æˆåŠŸåå­˜å‚¨åˆ°ç¼“å­˜
tfm_cache(cache_key) = tfm;
```

### ä¼˜åŒ–æ•ˆæœ
- é¿å…äº† TFM/PK æ–‡ä»¶çš„é‡å¤ç£ç›˜ I/O
- æå‡äº†å­—ä½“åŠ è½½æ€§èƒ½ï¼Œç‰¹åˆ«æ˜¯å¯¹äºå¸¸ç”¨å­—ä½“
- å‡å°‘äº†ç³»ç»Ÿè°ƒç”¨å’Œæ–‡ä»¶è®¿é—®å¼€é”€

## 3. ä¼˜åŒ–æ•ˆæœæ€»ç»“

### æ€§èƒ½æ”¹è¿›
1. **å­—ä½“å­˜åœ¨æ€§æ£€æŸ¥**ï¼šå‡å°‘äº†é‡å¤çš„å­—ä½“å­˜åœ¨æ£€æŸ¥å¼€é”€
2. **æ–‡ä»¶åŠ è½½**ï¼šé¿å…äº† TFM/PK æ–‡ä»¶çš„é‡å¤ç£ç›˜åŠ è½½
3. **ç³»ç»Ÿå“åº”**ï¼šæå‡äº†å­—ä½“åŠ è½½çš„æ•´ä½“æ€§èƒ½

### æ€§èƒ½å¯¹æ¯”è¡¨æ ¼(Windowså¹³å°æµ‹è¯•)

åŸºäºä¸‰æ¬¡æµ‹è¯•è¿è¡Œçš„å¹³å‡æ•°æ®å¯¹æ¯”ï¼ˆå•ä½ï¼šmsï¼‰ï¼š

| æ€§èƒ½æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–åï¼ˆå¹³å‡ï¼‰ | å˜åŒ– | è¯„ä¼° |
|----------|--------|----------------|------|------|
| **æµ®ç‚¹è®¡ç®—æ€§èƒ½** | | | | |
| `font_script_calculation` (180,100æ¬¡) | 36ms | 36.0ms | 0% | âœ… ä¿æŒä¼˜å¼‚ |
| `to_tex_font_size_conversion` (130,000æ¬¡) | 25ms | 24.3ms | -2.8% | âœ… ä¿æŒä¼˜å¼‚ |
| **å­—ä½“ç³»ç»Ÿæ€§èƒ½** | | | | |
| `tt_locate_all` | 98ms | 108.7ms | +10.9% | âš ï¸ è½»å¾®æ³¢åŠ¨ |
| `tt_font_exists NotoSerifCJK-Regular` | 108ms | 113.0ms | +4.6% | âš ï¸ è½»å¾®æ³¢åŠ¨ |
| `find font` (15æ¬¡) | 23ms | 23.3ms | +1.3% | âš ï¸ åŸºæœ¬æŒå¹³ |
| **æ–‡ä»¶åŠ è½½æ€§èƒ½** | | | | |
| `load tex font` (6æ¬¡) | 21ms | 19.3ms | -8.1% | âœ… æœ‰æ‰€æ”¹å–„ |
| `decode tfm` (6æ¬¡) | 0ms | 0ms | 0% | âœ… ä¿æŒæœ€ä½³ |
| `load tt face` (6æ¬¡) | 0ms | 2.0ms | +2ms | âš ï¸ è½»å¾®å¢åŠ  |

**æ³¨**ï¼š
1. ä¼˜åŒ–å‰æ•°æ®æ¥è‡ªç¬¬åäºŒé˜¶æ®µæ€§èƒ½åˆ†æï¼ˆè§ä¸Šæ–‡ï¼‰
2. ä¼˜åŒ–åæ•°æ®åŸºäºä¸‰æ¬¡æµ‹è¯•è¿è¡Œçš„å¹³å‡å€¼ï¼ˆ103/111/112ms, 105/111/123ms, 12/35/23ms, 10/33/15ms, 0/0/0ms, 2/2/2msï¼‰
3. æµ®ç‚¹è®¡ç®—æ€§èƒ½ä¿æŒä¼˜å¼‚ï¼ˆ0.2Î¼s/æ¬¡ï¼‰ï¼Œæ— éœ€è¿›ä¸€æ­¥ä¼˜åŒ–
4. å­—ä½“ç³»ç»Ÿæ€§èƒ½å—ç³»ç»Ÿèµ„æºæ³¢åŠ¨å½±å“è¾ƒå¤§ï¼Œä¼˜åŒ–æ•ˆæœéœ€é•¿æœŸè§‚å¯Ÿ
5. æ–‡ä»¶åŠ è½½æ€§èƒ½æœ‰æ‰€æ”¹å–„ï¼Œ`load tex font` å‡å°‘ 8.1%
6. Windowså¹³å°ä¼˜åŒ–ä¸æ˜æ˜¾ï¼ŒmacOSä¸Šæ˜æ˜¾å¾ˆå¤š

# ç¬¬åå››é˜¶æ®µå®Œæˆæƒ…å†µï¼šä»£ç ä¼˜åŒ–

å·²å®æ–½ä»¥ä¸‹ä¼˜åŒ–ï¼š

## 1. é‡å¤ä»£ç æå–ä¼˜åŒ–

### ä¼˜åŒ–å†…å®¹
- æ–°å¢ `normalize_half_multiple_size()` è¾…åŠ©å‡½æ•°ï¼Œå°†é‡å¤çš„0.5å€æ•°éªŒè¯é€»è¾‘ç»Ÿä¸€åˆ°å•ä¸€å‡½æ•°
- å‡½æ•°åŠŸèƒ½ï¼šéªŒè¯è¾“å…¥æ˜¯å¦ä¸º0.5å€æ•°ï¼Œå¦‚æœä¸æ˜¯åˆ™å››èˆäº”å…¥åˆ°æœ€è¿‘çš„0.5å€æ•°
- å‡½æ•°ä½ç½®ï¼š`src/Graphics/Fonts/font.hpp`ï¼Œåœ¨ `is_half_multiple()` å’Œ `round_to_half_multiple()` å‡½æ•°ä¹‹å

### ä»£ç å˜æ›´
```cpp
// éªŒè¯è¾“å…¥æ˜¯å¦ä¸º0.5å€æ•°
inline double normalize_half_multiple_size (double sz) {
  if (!is_half_multiple (sz)) return round_to_half_multiple (sz);
  return sz;
}
```

### å½±å“æ–‡ä»¶
ä»¥ä¸‹8ä¸ªæ–‡ä»¶ä¸­çš„é‡å¤éªŒè¯é€»è¾‘è¢«ç»Ÿä¸€æ›¿æ¢ï¼š
1. `src/Graphics/Fonts/font.cpp`: `script()` å‡½æ•°
2. `src/Graphics/Fonts/font.hpp`: `effective_size()` å’Œ `set_font_size()` å‡½æ•°
3. `src/Graphics/Fonts/smart_font.cpp`: `smart_font_bis()`, `smart_font()`, `math_smart_font()`, `prog_smart_font()` å‡½æ•°
4. `src/Plugins/Freetype/tt_font.cpp`: `tt_font()` å‡½æ•°å’Œæ„é€ å‡½æ•°
5. `src/Plugins/Freetype/unicode_font.cpp`: `unicode_font()` å‡½æ•°å’Œæ„é€ å‡½æ•°
6. `src/Plugins/Metafont/tex_font.cpp`: å¤šä¸ª `tex_*_font()` å‡½æ•°å’Œæ„é€ å‡½æ•°
7. `src/Plugins/Qt/qt_font.cpp`: `qt_font()` å‡½æ•°å’Œæ„é€ å‡½æ•°ï¼ˆç‰¹æ®Šå¤„ç†ï¼‰
8. `src/Typeset/Env/env_semantics.cpp`: `get_script_size()` å‡½æ•°

## 2. Qtå­—ä½“ç‰¹æ®Šå¤„ç†ä¼˜åŒ–

### ä¼˜åŒ–å†…å®¹
- `qt_font.cpp` ä¸­çš„æ„é€ å‡½æ•°ä¼˜åŒ–ï¼šä»…åœ¨å°ºå¯¸å®é™…æ”¹å˜æ—¶æ‰é‡æ–°åˆå§‹åŒ– QFont å¯¹è±¡
- ä½¿ç”¨ `fabs(normalized_size - size) > 1e-6` åˆ¤æ–­æ˜¯å¦éœ€è¦é‡æ–°åˆå§‹åŒ–
- é¿å…ä¸å¿…è¦çš„ QFont å’Œ QFontMetricsF å¯¹è±¡é‡å»º

### ä»£ç å˜æ›´
```cpp
double normalized_size= normalize_half_multiple_size (size);
if (fabs (normalized_size - size) > 1e-6) {
  size= normalized_size;
  // é‡æ–°åˆå§‹åŒ– QFont å’Œ QFontMetricsF ä½¿ç”¨ä¿®æ­£åçš„å°ºå¯¸
  qfn= QFont (to_qstring (family), size);
  qfm= QFontMetricsF (qfn);
}
```

## 3. ä¼˜åŒ–æ•ˆæœæ€»ç»“

### ä»£ç è´¨é‡æ”¹è¿›
1. **æ¶ˆé™¤é‡å¤ä»£ç **: ç›¸åŒéªŒè¯é€»è¾‘ä»å¤šå¤„ç»Ÿä¸€åˆ°å•ä¸€å‡½æ•°
2. **æé«˜å¯ç»´æŠ¤æ€§**: æœªæ¥ä¿®æ”¹0.5å€æ•°éªŒè¯é€»è¾‘åªéœ€ä¿®æ”¹ä¸€å¤„
3. **ä»£ç ä¸€è‡´æ€§**: æ‰€æœ‰å­—ä½“åˆ›å»ºå‡½æ•°ä½¿ç”¨ç›¸åŒçš„éªŒè¯æ¨¡å¼
4. **æ€§èƒ½è€ƒè™‘**: Qtå­—ä½“ä»…åœ¨å°ºå¯¸å®é™…æ”¹å˜æ—¶æ‰é‡æ–°åˆå§‹åŒ–å¯¹è±¡

### æŠ€æœ¯ç»†èŠ‚éªŒè¯
- `normalize_half_multiple_size()` å®ç°æ­£ç¡®ï¼šå…ˆæ£€æŸ¥æ˜¯å¦ä¸º0.5å€æ•°ï¼Œä¸æ˜¯åˆ™å››èˆäº”å…¥
- æ‰€æœ‰è°ƒç”¨ç‚¹æ­£ç¡®å¤„ç†æµ®ç‚¹å°ºå¯¸æ ‡å‡†åŒ–
- å‘åå…¼å®¹æ€§å¾—åˆ°ä¿æŒï¼š`effective_size()`ã€`set_font_size()` ç­‰å…³é”®å‡½æ•°è¡Œä¸ºä¸å˜

# æ€»ç»“

## é¡¹ç›®æ•´ä½“çŠ¶æ€
**æ ¸å¿ƒåŠŸèƒ½å®Œæˆ**: å­—ä½“ç³»ç»Ÿå®Œæ•´æ”¯æŒ0.5å€æ•°å­—ä½“å°ºå¯¸
**å‘åå…¼å®¹æ€§**: ä¿æŒä¸ç°æœ‰æ•´æ•°å­—ä½“å°ºå¯¸çš„å…¼å®¹æ€§
**ä»£ç è´¨é‡**: æ‰€æœ‰ç¼–è¯‘ã€é“¾æ¥é”™è¯¯å·²ä¿®å¤ï¼Œå•å…ƒæµ‹è¯•å…¨éƒ¨é€šè¿‡
**ç³»ç»Ÿç¨³å®šæ€§**: è§£å†³äº†è¿è¡Œæ—¶é”™è¯¯ï¼Œç¡®ä¿ç¨‹åºç¨³å®šè¿è¡Œ
**æ€§èƒ½ç›‘æ§å°±ç»ª**: æ€§èƒ½ç›‘æ§ç³»ç»Ÿå·²å»ºç«‹ï¼Œç“¶é¢ˆå·²è¯†åˆ«

## æ ¸å¿ƒæˆæœ
1. **æ¶æ„è®¾è®¡**: åŒå­—æ®µæ¶æ„ï¼ˆ`size_int` + `size_float`ï¼‰å®ç°æ–°æ—§å…¼å®¹
2. **è¾“å…¥éªŒè¯**: è‡ªåŠ¨éªŒè¯å’Œä¿®æ­£0.5å€æ•°é™åˆ¶
3. **å‡½æ•°ç­¾åç»Ÿä¸€**: æ‰€æœ‰ç›¸å…³å‡½æ•°ä» `int sz` æ›´æ–°ä¸º `double sz`
4. **è®¡ç®—ç³»ç»Ÿé€‚é…**: `script()` å‡½æ•°å’Œå¸ƒå±€è®¡ç®—æ”¯æŒæµ®ç‚¹ç²¾åº¦
5. **æ’ä»¶ç³»ç»Ÿæ›´æ–°**: Qtã€Freetypeã€Metafont æ’ä»¶å®Œæ•´é€‚é…
6. **UIæ”¯æŒ**: å­—ä½“é¢„è®¾åˆ—è¡¨æ‰©å±•ï¼Œæ”¯æŒ0.5å€æ•°å°ºå¯¸
7. **ç±»å‹å®‰å…¨**: æ‰€æœ‰æµ®ç‚¹åˆ°SIè½¬æ¢æ·»åŠ å››èˆäº”å…¥å¤„ç†
8. **ç¼“å­˜ç³»ç»Ÿ**: å­—ä½“ç¼“å­˜æ”¯æŒæµ®ç‚¹å°ºå¯¸é”®
9. **æ€§èƒ½ç›‘æ§**: å»ºç«‹äº†æ€§èƒ½ç›‘æ§æœºåˆ¶ï¼Œè¯†åˆ«äº†å®é™…ç“¶é¢ˆ
