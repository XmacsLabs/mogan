# 205_12 使用MuPDF获取图片大小
## 如何测试
1. 打开`TeXmacs/tests/tmu/205_12.tmu`文档，观察显示效果（对比旧版本），各图片显示大小应一致。同时将该文档所有图片保存到本地。
2. 重启程序，在全新文档中，将上述保存的图片依次插入，各图片的大小均一致，且宽高数据以cm表示。
3. 向文档中拖拽插入其他格式的图片（bmp, tiff, pdf等），可以正确识别图片

## 2025/10/10 拖拽插入PDF图片宽高获取
### What
拖拽插入图片场景，增加对PDF格式图片的支持
### Why
拖拽插入PDF图片，无法写入宽高

## 2025/09/28
### What
1. 新实现`double get_real_size_from_dpi(int px, int dpi)`，该函数根据像素数量与DPI数值，计算出实际显示尺寸，并四舍五入到2位小数，输出值单位为cm。
2. 新实现`void format_picsize_string (index_type px, index_type dpi, int& w, int& h, string* wcm, string* hcm)`，用于将图片的像素长宽，按照给定的DPI，转换为以pt为单位（1/72英寸）的长宽数据，保存在`w，h`变量中，同时将图像的实际尺寸用cm为单位，写入`wcm, hcm`变量中。
3. 普通位图的DPI从图片元数据中读取，PDF图片DPI默认保持72。
4. 程序中需要获取图片尺寸数据的地方，使用上述策略获取。

### Why
将所有图片单位统一为cm表示

## 2025/09/13
### What
1. 根据[[201_22] 拖拽图片到编辑器时直接嵌入](https://gitee.com/XmacsLabs/mogan/pulls/662)的思想，基于MuPDF技术栈，实现同样功能的`mupdf_load_and_parse_image`，该函数完成拖拽图片时，加载与解析图片大小的工作。
2. 根据[[201_21] 粘贴链接图片时直接嵌入图片](https://gitee.com/XmacsLabs/mogan/pulls/651)的思想，改用`mupdf_load_and_parse_image`实现相同功能。
3. 在拖拽插入图片的场景支持更多图片格式
4. 新实现`mupdf_read_from_url`，用于读取URL内容

### Why
基于MuPDF完成拖拽嵌入图片场景的适配

## 2025/09/10
### What
参考`qt_image_size()`：
1. 实现`mupdf_normal_image_size()`获取普通图片大小。
2. 实现`mupdf_pdf_image_size()`获取PDF图片的大小。
上述两个函数将替代原有的`qt_image_size()`和`hummus_pdf_image_size()`

### Why
原有`hummus_pdf_image_size()`获取PDF尺寸时，未考虑编辑器的 pt, px 单位转换，造成同一尺寸图片，在转换为PDF插入后相比原格式会变大
在启用MuPDF渲染器后，使用MuPDF图片解析功能获取各种图片的大小。
