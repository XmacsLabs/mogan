# 205_16 修复使用mupdf后图片旋转失效的问题

## 如何测试

打开`TeXmacs/tests/tmu/205_16.tmu`，看图片、文本和表格的旋转是否是以图片为中心。

## 2025/12/04 修复文本旋转速度异常问题
### What
1. 修改了 `set_transformation` 函数中的矩阵调整逻辑，使用正确的 Y 轴反转公式：`M' = S * M * S`，其中 `S = [1, 0; 0, -1]` 是 Y 轴反转矩阵
2. 移除了 `begin_text` 函数中对文本位置的额外矩阵变换，让 PDF 的当前变换矩阵直接处理文本旋转

### Why
1. **之前的矩阵调整公式有问题**：之前的代码使用 `b'=-b, c'=-c, e'=e+c, f'=f+b` 的公式，这虽然能反转旋转方向，但不是标准的坐标系转换方法。正确的做法是使用 `M' = S * M * S`，其中 `S` 是 Y 轴反转矩阵，这能正确处理 Qt（Y 轴向下）和 PDF（Y 轴向上）之间的坐标系差异。
2. **文本位置被双重变换**：在 `begin_text` 函数中，文本位置先被 `transform_matrix` 变换一次，然后 PDF 的当前图形状态又应用了一次变换，导致旋转速度看起来是正常的两倍。移除这个额外的变换后，文本旋转恢复正常。

### How
1. **坐标系差异**：
   - Qt 使用屏幕坐标系：Y 轴向下为正
   - PDF 使用笛卡尔坐标系：Y 轴向上为正
   - 需要转换矩阵 `S = [1, 0; 0, -1]` 来反转 Y 轴
2. **矩阵变换规则**：
   - 要将 Qt 坐标系中的变换矩阵 `M` 转换到 PDF 坐标系，需要应用：`M' = S * M * S⁻¹`
   - 由于 `S = S⁻¹`（因为 `S * S = I`），所以简化为：`M' = S * M * S`
3. **对旋转矩阵的影响**：
   - 如果 `M` 是逆时针旋转 θ 角度：`[cosθ, -sinθ; sinθ, cosθ]`
   - 那么 `M' = S * M * S = [cosθ, sinθ; -sinθ, cosθ]`，这是顺时针旋转 θ 角度
   - 这就是为什么之前旋转方向看起来是反的
4. **文本位置处理**：
   - 文本坐标 `(prev_text_x, prev_text_y)` 已经是 Qt 坐标系中的坐标
   - PDF 图形状态已经应用了 `M'` 变换
   - 因此文本位置不需要额外的矩阵变换，直接使用原始坐标即可

## 2025/12/02 图片旋转改为逆时针，修改旋转中心
### What
1.  旋转方向反转：`transform_matrix.b = -transform_matrix.b;transform_matrix.c = -transform_matrix.c;`
2.  中心点保持：根据公式 e' = e + c 和 f' = f + b 调整原点。