# 207_12 优化大文档视图缩放卡顿

## 2025/10/2
### 如何测试
打开一个大文档（.tm/.tmu格式），在任意位置缩放（按住Ctrl并滚轮）多次并迅速，观察是否卡顿。

### What
在查看大文档时，缩放导致的重排版会给渲染引擎造成巨大压力，导致界面卡顿，响应速度极慢。

### Why
在原逻辑中，只要涉及环境变化时都会触发重新排版：

```cpp
if (env_change & (THE_TREE + THE_ENVIRONMENT)) {
	typeset_invalidate_env ();
	SI x1, y1, x2, y2;
	bench_start ("typeset " * (as_string (buf->buf->name)));
	typeset (x1, y1, x2, y2);
	bench_end ("typeset " * (as_string (buf->buf->name)), 1000);
	invalidate (x1 - 2 * pixel, y1 - 2 * pixel, x2 + 2 * pixel, y2 + 2 * pixel);
	// check_data_integrety ();
	the_ghost_cursor ()= eb->find_check_cursor (tp);
}
```

而事实上，在非automatic模式下，版面尺寸并不依赖缩放或窗口高宽的变化。缩放仅是视觉倍率变化，没有必要进行一次typeset重排。

### How
当eb非空（即已经存在布局）且不在automatic模式下时，允许跳过重排。并确保除本次缩放外没有其他环境变化改变而需要重排版，故在之前存一个env_change的快照并特判：

```cpp
// If zoom-only and medium != automatic, skip re-typeset.
if (zoom_changed) {
	string medium= get_init_string (PAGE_MEDIUM);
	if (medium != "automatic") {
		// Require valid layout and no pre-existing env change.
		bool pre_env_pending = (env_before_zoom_update & THE_ENVIRONMENT) != 0;
		if (!is_nil (eb) && !pre_env_pending) skip_typeset_due_to_zoom= true;
	}
}
```

另外为确保因本次skip造成的后续env查询读到旧值，在重排的跳过情况下仍然调用`typeset_invalidate_env()`清空环境缓存：

```cpp
if (env_change & THE_ENVIRONMENT) {
	if (!skip_typeset_due_to_zoom) typeset_invalidate_all ();
	else typeset_invalidate_env ();
}
```